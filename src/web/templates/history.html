{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Workout History</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Recent Workouts</h5>
                            <div class="sorting-controls">
                                <label for="sort-by" class="me-2">Sort by:</label>
                                <select id="sort-by" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                                    <option value="date-desc">Date (newest first)</option>
                                    <option value="date-asc">Date (oldest first)</option>
                                    <option value="duration-desc">Duration (longest first)</option>
                                    <option value="duration-asc">Duration (shortest first)</option>
                                    <option value="distance-desc">Distance (longest first)</option>
                                    <option value="distance-asc">Distance (shortest first)</option>
                                    <option value="calories-desc">Calories (highest first)</option>
                                    <option value="calories-asc">Calories (lowest first)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="workouts-list">
                            <p>Loading workouts...</p>
                        </div>
                        <div id="pagination" class="mt-3">
                            <button id="prev-page-btn" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                            <span id="page-info" class="mx-2">Page 1</span>
                            <button id="next-page-btn" class="btn btn-sm btn-outline-primary" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Workout Details</h5>
                    </div>
                    <div class="card-body">
                        <div id="workout-details">
                            <p>Select a workout to view details.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM elements
    const workoutsList = document.getElementById('workouts-list');
    const workoutDetails = document.getElementById('workout-details');
    const prevPageBtn = document.getElementById('prev-page-btn');
    const nextPageBtn = document.getElementById('next-page-btn');
    const pageInfo = document.getElementById('page-info');
    const sortBySelect = document.getElementById('sort-by');
    
    // Pagination and sorting state
    let currentPage = 1;
    const pageSize = 10;
    let totalWorkouts = 0;
    let currentSort = 'date-desc'; // Default sort
    let allWorkouts = []; // Store all loaded workouts for client-side sorting
    
    // Format duration function
    function formatDuration(seconds) {
        if (!seconds || isNaN(seconds)) return '-';
        
        seconds = Math.round(seconds);
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        return [
            hours.toString().padStart(2, '0'),
            minutes.toString().padStart(2, '0'),
            secs.toString().padStart(2, '0')
        ].join(':');
    }
    
    // Format timestamp for chart labels
    function formatTimestamp(seconds) {
        if (!seconds || isNaN(seconds)) return '';
        
        seconds = Math.round(seconds);
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Sort workouts based on the selected sort option
    function sortWorkouts(workouts, sortOption) {
        const [field, direction] = sortOption.split('-');
        const directionMultiplier = direction === 'asc' ? 1 : -1;
        
        return [...workouts].sort((a, b) => {
            let valueA, valueB;
            
            switch (field) {
                case 'date':
                    // Convert dates to timestamps for comparison
                    valueA = a.start_time ? new Date(a.start_time).getTime() : 0;
                    valueB = b.start_time ? new Date(b.start_time).getTime() : 0;
                    break;
                    
                case 'duration':
                    valueA = a.duration || 0;
                    valueB = b.duration || 0;
                    break;
                    
                case 'distance':
                    // Extract distance from summary or default to 0
                    valueA = (a.summary && a.summary.total_distance) ? a.summary.total_distance : 0;
                    valueB = (b.summary && b.summary.total_distance) ? b.summary.total_distance : 0;
                    break;
                    
                case 'calories':
                    // Extract calories from summary or default to 0
                    valueA = (a.summary && a.summary.total_calories) ? a.summary.total_calories : 0;
                    valueB = (b.summary && b.summary.total_calories) ? b.summary.total_calories : 0;
                    break;
                    
                default:
                    return 0;
            }
            
            return directionMultiplier * (valueA - valueB);
        });
    }
    
    // Load and display all workouts
    function loadAllWorkouts() {
        workoutsList.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading workouts...</p>';
        
        console.log("Fetching workouts from /api/workouts...");
        
        fetch('/api/workouts')
            .then(response => {
                console.log("Response status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("Workouts API full response:", data); // Enhanced debug output
                
                if (data.success && data.workouts && data.workouts.length > 0) {
                    console.log(`Successfully loaded ${data.workouts.length} workouts`);
                    // Store all workouts
                    allWorkouts = data.workouts;
                    
                    // Apply sorting and display the first page
                    applySort();
                } else if (data.success && (!data.workouts || data.workouts.length === 0)) {
                    console.log("No workouts found in the response");
                    workoutsList.innerHTML = '<div class="alert alert-info">No workouts found. Start tracking your workouts on the <a href="/workout">Workout</a> page.</div>';
                    prevPageBtn.disabled = true;
                    nextPageBtn.disabled = true;
                } else {
                    console.error("Error in API response:", data);
                    workoutsList.innerHTML = `<div class="alert alert-danger">Error loading workouts: ${data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching workouts:', error);
                workoutsList.innerHTML = `<div class="alert alert-danger">Error loading workouts: ${error.message}</div>`;
            });
    }
    
    // Apply current sort option and show the appropriate page
    function applySort() {
        if (allWorkouts.length === 0) return;
        
        // Get sort option from the select element
        currentSort = sortBySelect.value;
        
        // Sort the workouts
        const sortedWorkouts = sortWorkouts(allWorkouts, currentSort);
        
        // Calculate pagination details
        totalWorkouts = sortedWorkouts.length;
        const totalPages = Math.ceil(totalWorkouts / pageSize);
        
        // Ensure currentPage is within valid range
        if (currentPage > totalPages) {
            currentPage = totalPages;
        }
        
        // Get the workouts for the current page
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, sortedWorkouts.length);
        const pagedWorkouts = sortedWorkouts.slice(startIndex, endIndex);
        
        // Display the workouts
        displayWorkouts(pagedWorkouts);
        
        // Update pagination controls
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage >= totalPages;
    }
    
    // Load workouts
    function loadWorkouts(page = 1) {
        const offset = (page - 1) * pageSize;
        
        workoutsList.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading workouts...</p>';
        
        fetch(`/api/workouts?limit=${pageSize}&offset=${offset}`)
            .then(response => response.json())
            .then(data => {
                console.log("Workouts API response:", data); // Debug output
                
                if (data.success) {
                    if (data.workouts && data.workouts.length > 0) {
                        displayWorkouts(data.workouts);
                        totalWorkouts = data.workouts.length;
                        
                        // Update pagination
                        currentPage = page;
                        pageInfo.textContent = `Page ${currentPage}`;
                        prevPageBtn.disabled = currentPage === 1;
                        nextPageBtn.disabled = data.workouts.length < pageSize;
                    } else {
                        workoutsList.innerHTML = '<div class="alert alert-info">No workouts found. Start tracking your workouts on the <a href="/workout">Workout</a> page.</div>';
                        prevPageBtn.disabled = true;
                        nextPageBtn.disabled = true;
                    }
                } else {
                    workoutsList.innerHTML = `<div class="alert alert-danger">Error loading workouts: ${data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                workoutsList.innerHTML = `<div class="alert alert-danger">Error loading workouts: ${error.message}</div>`;
                console.error('Error loading workouts:', error);
            });
    }
    
    // Display workouts
    function displayWorkouts(workouts) {
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += `
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Duration</th>
                    <th>Distance</th>
                    <th>Calories</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        workouts.forEach(workout => {
            // Parse the start time with fallback handling
            let startTimeStr = '-';
            try {
                const startTime = workout.start_time ? new Date(workout.start_time) : new Date();
                startTimeStr = startTime.toLocaleString();
            } catch (e) {
                console.error("Error parsing start time:", e, workout.start_time);
            }
            
            // Safely extract summary values with fallbacks
            const duration = formatDuration(workout.duration);
            const distance = (workout.summary && workout.summary.total_distance) ? 
                Math.round(workout.summary.total_distance) + ' m' : '-';
            const calories = (workout.summary && workout.summary.total_calories) ? 
                Math.round(workout.summary.total_calories) + ' kcal' : '-';
                
            const workoutType = workout.workout_type ? 
                workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1) : 'Unknown';
            
            html += `
                <tr data-workout-id="${workout.id}" class="workout-row">
                    <td>${startTimeStr}</td>
                    <td>${workoutType}</td>
                    <td>${duration}</td>
                    <td>${distance}</td>
                    <td>${calories}</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-btn" data-workout-id="${workout.id}">View</button>
                        <button class="btn btn-sm btn-success fit-btn" data-workout-id="${workout.id}">FIT</button>
                        <button class="btn btn-sm btn-info upload-btn" data-workout-id="${workout.id}">Upload</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-workout-id="${workout.id}">Delete</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        workoutsList.innerHTML = html;
        
        // Add event listeners to buttons
        document.querySelectorAll('.view-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                loadWorkoutDetails(workoutId);
                
                // Highlight selected row
                document.querySelectorAll('.workout-row').forEach(r => r.classList.remove('table-active'));
                this.closest('tr').classList.add('table-active');
            });
        });
        
        document.querySelectorAll('.fit-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                convertToFIT(workoutId);
            });
        });
        
        document.querySelectorAll('.upload-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                uploadToGarmin(workoutId);
            });
        });
        
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                const confirmDelete = confirm("Are you sure you want to delete this workout? This action cannot be undone and will remove all workout data from the database.");
                
                if (confirmDelete) {
                    deleteWorkout(workoutId);
                }
            });
        });
        
        // Add click event to rows
        document.querySelectorAll('.workout-row').forEach(row => {
            row.addEventListener('click', function() {
                const workoutId = this.dataset.workoutId;
                loadWorkoutDetails(workoutId);
                
                // Highlight selected row
                document.querySelectorAll('.workout-row').forEach(r => r.classList.remove('table-active'));
                this.classList.add('table-active');
            });
        });
    }
    
    // Load workout details
    function loadWorkoutDetails(workoutId) {
        workoutDetails.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading workout details...</p>';
        
        fetch(`/api/workout/${workoutId}`)
            .then(response => response.json())
            .then(data => {
                console.log("Workout details API response:", data); // Debug output
                
                if (data.success && data.workout) {
                    displayWorkoutDetails(data.workout);
                } else {
                    workoutDetails.innerHTML = `<div class="alert alert-danger">Error loading workout details: ${data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                workoutDetails.innerHTML = `<div class="alert alert-danger">Error loading workout details: ${error.message}</div>`;
                console.error('Error loading workout details:', error);
            });
    }
    
    // Display workout details
    function displayWorkoutDetails(workout) {
        console.log("Displaying workout details:", workout);
        
        // Parse dates with fallback handling
        let startTimeStr = '-';
        try {
            const startTime = workout.start_time ? new Date(workout.start_time) : new Date();
            startTimeStr = startTime.toLocaleString();
        } catch (e) {
            console.error("Error parsing start time:", e, workout.start_time);
        }
        
        let endTimeStr = '-';
        try {
            if (workout.end_time) {
                const endTime = new Date(workout.end_time);
                endTimeStr = endTime.toLocaleString();
            }
        } catch (e) {
            console.error("Error parsing end time:", e, workout.end_time);
        }
        
        const duration = formatDuration(workout.duration);
        const workoutType = workout.workout_type ? 
            workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1) : 'Unknown';
        
        let html = '<div class="row">';
        
        // Workout info
        html += `
            <div class="col-md-6">
                <h5>Workout Information</h5>
                <table class="table">
                    <tr>
                        <th>Date</th>
                        <td>${startTimeStr}</td>
                    </tr>
                    <tr>
                        <th>End Time</th>
                        <td>${endTimeStr}</td>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <td>${workoutType}</td>
                    </tr>
                    <tr>
                        <th>Duration</th>
                        <td>${duration}</td>
                    </tr>
                    <tr>
                        <th>Device</th>
                        <td>${workout.device_name || '-'}</td>
                    </tr>
                    <tr>
                        <th>Data Points</th>
                        <td>${workout.data_point_count || 0}</td>
                    </tr>
                </table>
            </div>
        `;
        
        // Summary metrics
        html += '<div class="col-md-6">';
        html += '<h5>Summary Metrics</h5>';
        
        if (workout.summary && Object.keys(workout.summary).length > 0) {
            html += '<table class="table">';
            
            // Add metrics based on workout type
            if (workout.workout_type === 'bike') {
                // Bike metrics
                if (workout.summary.avg_power !== undefined) {
                    html += `<tr><th>Avg Power</th><td>${Math.round(workout.summary.avg_power)} W</td></tr>`;
                }
                if (workout.summary.max_power !== undefined) {
                    html += `<tr><th>Max Power</th><td>${Math.round(workout.summary.max_power)} W</td></tr>`;
                }
                if (workout.summary.avg_cadence !== undefined) {
                    html += `<tr><th>Avg Cadence</th><td>${Math.round(workout.summary.avg_cadence)} rpm</td></tr>`;
                }
                if (workout.summary.max_cadence !== undefined) {
                    html += `<tr><th>Max Cadence</th><td>${Math.round(workout.summary.max_cadence)} rpm</td></tr>`;
                }
                if (workout.summary.avg_speed !== undefined) {
                    const avgSpeedKmh = workout.summary.avg_speed * 3.6; // Convert m/s to km/h
                    html += `<tr><th>Avg Speed</th><td>${avgSpeedKmh.toFixed(1)} km/h</td></tr>`;
                }
            } else if (workout.workout_type === 'rower') {
                // Rower metrics
                if (workout.summary.avg_power !== undefined) {
                    html += `<tr><th>Avg Power</th><td>${Math.round(workout.summary.avg_power)} W</td></tr>`;
                }
                if (workout.summary.max_power !== undefined) {
                    html += `<tr><th>Max Power</th><td>${Math.round(workout.summary.max_power)} W</td></tr>`;
                }
                if (workout.summary.avg_stroke_rate !== undefined) {
                    html += `<tr><th>Avg Stroke Rate</th><td>${Math.round(workout.summary.avg_stroke_rate)} spm</td></tr>`;
                }
                if (workout.summary.max_stroke_rate !== undefined) {
                    html += `<tr><th>Max Stroke Rate</th><td>${Math.round(workout.summary.max_stroke_rate)} spm</td></tr>`;
                }
                if (workout.summary.total_strokes !== undefined) {
                    html += `<tr><th>Total Strokes</th><td>${Math.round(workout.summary.total_strokes)}</td></tr>`;
                }
            }
            
            // Common metrics
            if (workout.summary.avg_heart_rate !== undefined) {
                html += `<tr><th>Avg Heart Rate</th><td>${Math.round(workout.summary.avg_heart_rate)} bpm</td></tr>`;
            }
            if (workout.summary.max_heart_rate !== undefined) {
                html += `<tr><th>Max Heart Rate</th><td>${Math.round(workout.summary.max_heart_rate)} bpm</td></tr>`;
            }
            if (workout.summary.total_distance !== undefined) {
                html += `<tr><th>Total Distance</th><td>${Math.round(workout.summary.total_distance)} m</td></tr>`;
            }
            if (workout.summary.total_calories !== undefined) {
                html += `<tr><th>Total Calories</th><td>${Math.round(workout.summary.total_calories)} kcal</td></tr>`;
            }
            if (workout.summary.estimated_vo2max !== undefined) {
                html += `<tr><th>Estimated VO2 Max</th><td>${workout.summary.estimated_vo2max.toFixed(1)} ml/kg/min</td></tr>`;
            }
            
            html += '</table>';
        } else {
            html += '<div class="alert alert-warning">No summary data available for this workout.</div>';
        }
        
        html += '</div>';
        html += '</div>';
        
        // Add chart if data series is available
        if (workout.data_series && 
            (workout.data_series.powers.length > 0 || 
             workout.data_series.heart_rates.length > 0 || 
             workout.data_series.cadences.length > 0)) {
            
            html += `
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5>Workout Chart</h5>
                        <div class="chart-container" style="position: relative; height:300px; max-height:300px; margin-bottom:20px;">
                            <canvas id="workout-chart"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }
        
        workoutDetails.innerHTML = html;
        
        // Create chart if data series is available
        if (workout.data_series && 
            (workout.data_series.powers.length > 0 || 
             workout.data_series.heart_rates.length > 0 || 
             workout.data_series.cadences.length > 0)) {
            
            try {
                createWorkoutChart(workout);
            } catch (e) {
                console.error("Error creating workout chart:", e);
                document.querySelector('.chart-container').innerHTML = 
                    `<div class="alert alert-danger">Error creating chart: ${e.message}</div>`;
            }
        }
    }
    
    // Create workout chart - improved to handle timestamps better
    function createWorkoutChart(workout) {
        const ctx = document.getElementById('workout-chart').getContext('2d');
        
        // Get data series from the workout object
        const timestamps = workout.data_series.timestamps || [];
        const powers = workout.data_series.powers || [];
        const heartRates = workout.data_series.heart_rates || [];
        const cadences = workout.data_series.cadences || [];
        
        // Format timestamps as minute:second
        const formattedLabels = timestamps.map(ts => formatTimestamp(ts));
        
        // Create datasets
        const datasets = [];
        
        if (powers.length > 0) {
            datasets.push({
                label: 'Power (watts)',
                data: powers,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                yAxisID: 'y',
                fill: false
            });
        }
        
        if (heartRates.length > 0) {
            datasets.push({
                label: 'Heart Rate (bpm)',
                data: heartRates,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                yAxisID: 'y1',
                fill: false
            });
        }
        
        if (cadences.length > 0) {
            datasets.push({
                label: workout.workout_type === 'rower' ? 'Stroke Rate (spm)' : 'Cadence (rpm)',
                data: cadences,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                yAxisID: 'y2',
                fill: false
            });
        }
        
        // Add speed dataset if available
        if (workout.data_series.speeds && workout.data_series.speeds.length > 0) {
            // Convert speeds from m/s to km/h
            const speedsKmh = workout.data_series.speeds.map(speed => speed * 3.6);
            datasets.push({
                label: 'Speed (km/h)',
                data: speedsKmh,
                borderColor: 'rgba(153, 102, 255, 1)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                yAxisID: 'y3',
                fill: false
            });
        }
        
        // Create the chart
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: formattedLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                stacked: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Workout Data'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const idx = tooltipItems[0].dataIndex;
                                return `Time: ${formattedLabels[idx]}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time (min:sec)'
                        },
                        ticks: {
                            maxTicksLimit: 10,
                            callback: function(value, index, values) {
                                return formattedLabels[index];
                            }
                        }
                    },
                    y: {
                        type: 'linear',
                        display: powers.length > 0,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Power (watts)'
                        },
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        display: heartRates.length > 0,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Heart Rate (bpm)'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        beginAtZero: true
                    },
                    y2: {
                        type: 'linear',
                        display: cadences.length > 0,
                        position: 'right',
                        title: {
                            display: true,
                            text: workout.workout_type === 'rower' ? 'Stroke Rate (spm)' : 'Cadence (rpm)'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        beginAtZero: true
                    },
                    y3: {
                        type: 'linear',
                        display: workout.data_series.speeds && workout.data_series.speeds.length > 0,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Speed (km/h)'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Convert workout to FIT
    function convertToFIT(workoutId) {
        fetch(`/api/convert_fit/${workoutId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`FIT file created successfully: ${data.fit_file_name}`);
                loadWorkoutDetails(workoutId);
            } else {
                alert(`Error creating FIT file: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error creating FIT file: ${error.message}`);
            console.error('Error creating FIT file:', error);
        });
    }
    
    // Upload workout to Garmin Connect
    function uploadToGarmin(workoutId) {
        fetch(`/api/upload_garmin/${workoutId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Workout uploaded successfully to Garmin Connect. Activity ID: ${data.activity_id}`);
                loadWorkoutDetails(workoutId);
            } else {
                alert(`Error uploading to Garmin Connect: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error uploading to Garmin Connect: ${error.message}`);
            console.error('Error uploading to Garmin Connect:', error);
        });
    }
    
    // Delete workout
    function deleteWorkout(workoutId) {
        fetch(`/api/workout/${workoutId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Workout deleted successfully');
                // Clear workout details
                workoutDetails.innerHTML = '<p>Select a workout to view details.</p>';
                // Reload workout list
                loadWorkouts(currentPage);
            } else {
                alert(`Error deleting workout: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error deleting workout: ${error.message}`);
            console.error('Error deleting workout:', error);
        });
    }
    
    // Initialize on document load
    document.addEventListener('DOMContentLoaded', function() {
        // Load initial data
        loadAllWorkouts();
        
        // Set up sorting change event
        sortBySelect.addEventListener('change', function() {
            currentPage = 1; // Reset to first page when sort changes
            applySort();
        });
        
        // Set up pagination
        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                applySort(); // Apply sorting with new page
            }
        });
        
        nextPageBtn.addEventListener('click', function() {
            const totalPages = Math.ceil(totalWorkouts / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                applySort(); // Apply sorting with new page
            }
        });
        
        // Check if a workout ID is specified in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const workoutId = urlParams.get('workout_id');
        
        if (workoutId) {
            // Load details for the specified workout
            loadWorkoutDetails(workoutId);
        }
    });
</script>
{% endblock %}