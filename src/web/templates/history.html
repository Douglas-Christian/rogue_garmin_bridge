{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Workout History</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Recent Workouts</h5>
                            <div class="sorting-controls">
                                <label for="sort-by" class="me-2">Sort by:</label>
                                <select id="sort-by" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                                    <option value="date-desc">Date (newest first)</option>
                                    <option value="date-asc">Date (oldest first)</option>
                                    <option value="duration-desc">Duration (longest first)</option>
                                    <option value="duration-asc">Duration (shortest first)</option>
                                    <option value="distance-desc">Distance (longest first)</option>
                                    <option value="distance-asc">Distance (shortest first)</option>
                                    <option value="calories-desc">Calories (highest first)</option>
                                    <option value="calories-asc">Calories (lowest first)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="workouts-list">
                            <p>Loading workouts...</p>
                        </div>
                        <div id="pagination" class="mt-3">
                            <button id="prev-page-btn" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                            <span id="page-info" class="mx-2">Page 1</span>
                            <button id="next-page-btn" class="btn btn-sm btn-outline-primary" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Workout Details</h5>
                    </div>
                    <div class="card-body">
                        <div id="workout-details">
                            <p>Select a workout to view details.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM elements
    const workoutsList = document.getElementById('workouts-list');
    const workoutDetails = document.getElementById('workout-details');
    const prevPageBtn = document.getElementById('prev-page-btn');
    const nextPageBtn = document.getElementById('next-page-btn');
    const pageInfo = document.getElementById('page-info');
    const sortBySelect = document.getElementById('sort-by');
    
    // Pagination and sorting state
    let currentPage = 1;
    const pageSize = 10;
    let totalWorkouts = 0;
    let currentSort = 'date-desc'; // Default sort
    let allWorkouts = []; // Store all loaded workouts for client-side sorting
    
    // User's unit preference (will be loaded from settings)
    let userUnitSystem = 'metric';
    
    // Unit conversion utilities
    const unitConversions = {
        // Distance conversions
        mToMi: (m) => m / 1609.34,
        miToM: (mi) => mi * 1609.34,
        mToKm: (m) => m / 1000,
        kmToM: (km) => km * 1000,
        
        // Speed conversions
        msToKph: (ms) => ms * 3.6,
        msToMph: (ms) => ms * 2.23694,
        kphToMph: (kph) => kph * 0.621371,
        mphToKph: (mph) => mph / 0.621371
    };
    
    // Format duration function
    function formatDuration(seconds) {
        if (!seconds || isNaN(seconds)) return '-';
        
        seconds = Math.round(seconds);
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        return [
            hours.toString().padStart(2, '0'),
            minutes.toString().padStart(2, '0'),
            secs.toString().padStart(2, '0')
        ].join(':');
    }
    
    // Format timestamp for chart labels
    function formatTimestamp(seconds) {
        if (!seconds || isNaN(seconds)) return '';
        
        seconds = Math.round(seconds);
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Sort workouts based on the selected sort option
    function sortWorkouts(workouts, sortOption) {
        const [field, direction] = sortOption.split('-');
        const directionMultiplier = direction === 'asc' ? 1 : -1;
        
        return [...workouts].sort((a, b) => {
            let valueA, valueB;
            
            switch (field) {
                case 'date':
                    // Convert dates to timestamps for comparison
                    valueA = a.start_time ? new Date(a.start_time).getTime() : 0;
                    valueB = b.start_time ? new Date(b.start_time).getTime() : 0;
                    break;
                    
                case 'duration':
                    valueA = a.duration || 0;
                    valueB = b.duration || 0;
                    break;
                    
                case 'distance':
                    // Extract distance from summary or default to 0
                    valueA = (a.summary && a.summary.total_distance) ? a.summary.total_distance : 0;
                    valueB = (b.summary && b.summary.total_distance) ? b.summary.total_distance : 0;
                    break;
                    
                case 'calories':
                    // Extract calories from summary or default to 0
                    valueA = (a.summary && a.summary.total_calories) ? a.summary.total_calories : 0;
                    valueB = (b.summary && b.summary.total_calories) ? b.summary.total_calories : 0;
                    break;
                    
                default:
                    return 0;
            }
            
            return directionMultiplier * (valueA - valueB);
        });
    }
    
    // Load and display all workouts
    function loadAllWorkouts() {
        workoutsList.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading workouts...</p>';
        
        console.log("Fetching workouts from /api/workouts...");
        
        fetch('/api/workouts')
            .then(response => {
                console.log("Response status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("Workouts API full response:", data); // Enhanced debug output
                
                if (data.success && data.workouts && data.workouts.length > 0) {
                    console.log(`Successfully loaded ${data.workouts.length} workouts`);
                    // Store all workouts
                    allWorkouts = data.workouts;
                    
                    // Apply sorting and display the first page
                    applySort();
                } else if (data.success && (!data.workouts || data.workouts.length === 0)) {
                    console.log("No workouts found in the response");
                    workoutsList.innerHTML = '<div class="alert alert-info">No workouts found. Start tracking your workouts on the <a href="/workout">Workout</a> page.</div>';
                    prevPageBtn.disabled = true;
                    nextPageBtn.disabled = true;
                } else {
                    console.error("Error in API response:", data);
                    workoutsList.innerHTML = `<div class="alert alert-danger">Error loading workouts: ${data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching workouts:', error);
                workoutsList.innerHTML = `<div class="alert alert-danger">Error loading workouts: ${error.message}</div>`;
            });
    }
    
    // Apply current sort option and show the appropriate page
    function applySort() {
        if (allWorkouts.length === 0) return;
        
        // Get sort option from the select element
        currentSort = sortBySelect.value;
        
        // Sort the workouts
        const sortedWorkouts = sortWorkouts(allWorkouts, currentSort);
        
        // Calculate pagination details
        totalWorkouts = sortedWorkouts.length;
        const totalPages = Math.ceil(totalWorkouts / pageSize);
        
        // Ensure currentPage is within valid range
        if (currentPage > totalPages) {
            currentPage = totalPages;
        }
        
        // Get the workouts for the current page
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, sortedWorkouts.length);
        const pagedWorkouts = sortedWorkouts.slice(startIndex, endIndex);
        
        // Display the workouts
        displayWorkouts(pagedWorkouts);
        
        // Update pagination controls
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage >= totalPages;
    }
    
    // Load workouts
    function loadWorkouts(page = 1) {
        const offset = (page - 1) * pageSize;
        
        workoutsList.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading workouts...</p>';
        
        fetch(`/api/workouts?limit=${pageSize}&offset=${offset}`)
            .then(response => response.json())
            .then(data => {
                console.log("Workouts API response:", data); // Debug output
                
                if (data.success) {
                    if (data.workouts && data.workouts.length > 0) {
                        displayWorkouts(data.workouts);
                        totalWorkouts = data.workouts.length;
                        
                        // Update pagination
                        currentPage = page;
                        pageInfo.textContent = `Page ${currentPage}`;
                        prevPageBtn.disabled = currentPage === 1;
                        nextPageBtn.disabled = data.workouts.length < pageSize;
                    } else {
                        workoutsList.innerHTML = '<div class="alert alert-info">No workouts found. Start tracking your workouts on the <a href="/workout">Workout</a> page.</div>';
                        prevPageBtn.disabled = true;
                        nextPageBtn.disabled = true;
                    }
                } else {
                    workoutsList.innerHTML = `<div class="alert alert-danger">Error loading workouts: ${data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                workoutsList.innerHTML = `<div class="alert alert-danger">Error loading workouts: ${error.message}</div>`;
                console.error('Error loading workouts:', error);
            });
    }
    
    // Display workouts
    function displayWorkouts(workouts) {
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += `
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Duration</th>
                    <th>Distance</th>
                    <th>Calories</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        workouts.forEach(workout => {
            // Parse the start time with fallback handling
            let startTimeStr = '-';
            try {
                const startTime = workout.start_time ? new Date(workout.start_time) : new Date();
                startTimeStr = startTime.toLocaleString();
            } catch (e) {
                console.error("Error parsing start time:", e, workout.start_time);
            }
            
            // Safely extract summary values with fallbacks
            const duration = formatDuration(workout.duration);
            
            // Format distance with unit conversion based on user preference
            let distanceText = '-';
            if (workout.summary && workout.summary.total_distance) {
                const distanceM = workout.summary.total_distance;
                
                if (userUnitSystem === 'imperial') {
                    // Convert meters to miles
                    const distanceMi = unitConversions.mToMi(distanceM);
                    distanceText = distanceMi.toFixed(2) + ' mi';
                } else {
                    // Convert meters to kilometers
                    const distanceKm = unitConversions.mToKm(distanceM);
                    distanceText = distanceKm.toFixed(2) + ' km';
                }
            }
            
            const calories = (workout.summary && workout.summary.total_calories) ? 
                Math.round(workout.summary.total_calories) + ' kcal' : '-';
                
            const workoutType = workout.workout_type ? 
                workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1) : 'Unknown';
            
            html += `
                <tr data-workout-id="${workout.id}" class="workout-row">
                    <td>${startTimeStr}</td>
                    <td>${workoutType}</td>
                    <td>${duration}</td>
                    <td>${distanceText}</td>
                    <td>${calories}</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-btn" data-workout-id="${workout.id}">View</button>
                        <button class="btn btn-sm btn-success fit-btn" data-workout-id="${workout.id}">FIT</button>
                        <button class="btn btn-sm btn-info upload-btn" data-workout-id="${workout.id}">Upload</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-workout-id="${workout.id}">Delete</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        workoutsList.innerHTML = html;
        
        // Add event listeners to buttons
        document.querySelectorAll('.view-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                loadWorkoutDetails(workoutId);
                
                // Highlight selected row
                document.querySelectorAll('.workout-row').forEach(r => r.classList.remove('table-active'));
                this.closest('tr').classList.add('table-active');
            });
        });
        
        document.querySelectorAll('.fit-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                convertToFIT(workoutId);
            });
        });
        
        document.querySelectorAll('.upload-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                uploadToGarmin(workoutId);
            });
        });
        
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                const confirmDelete = confirm("Are you sure you want to delete this workout? This action cannot be undone and will remove all workout data from the database.");
                
                if (confirmDelete) {
                    deleteWorkout(workoutId);
                }
            });
        });
        
        // Add click event to rows
        document.querySelectorAll('.workout-row').forEach(row => {
            row.addEventListener('click', function() {
                const workoutId = this.dataset.workoutId;
                loadWorkoutDetails(workoutId);
                
                // Highlight selected row
                document.querySelectorAll('.workout-row').forEach(r => r.classList.remove('table-active'));
                this.classList.add('table-active');
            });
        });
    }
    
    // Load workout details
    function loadWorkoutDetails(workoutId) {
        workoutDetails.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading workout details...</p>';
        
        fetch(`/api/workout/${workoutId}`)
            .then(response => response.json())
            .then(data => {
                console.log("Workout details API response:", data); // Debug output
                
                if (data.success && data.workout) {
                    // Try to parse summary data if it's a string
                    if (data.workout.summary && typeof data.workout.summary === 'string') {
                        try {
                            console.log("Summary before parsing:", data.workout.summary);
                            data.workout.summary = JSON.parse(data.workout.summary);
                            console.log("Summary after parsing:", data.workout.summary);
                        } catch (e) {
                            console.error("Error parsing summary JSON:", e);
                            // If parsing fails, use an empty object
                            data.workout.summary = {};
                        }
                    }
                    
                    displayWorkoutDetails(data.workout);
                } else {
                    workoutDetails.innerHTML = `<div class="alert alert-danger">Error loading workout details: ${data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                workoutDetails.innerHTML = `<div class="alert alert-danger">Error loading workout details: ${error.message}</div>`;
                console.error('Error loading workout details:', error);
            });
    }
    
    // Display workout details
    function displayWorkoutDetails(workout) {
        // Clear previous details
        let detailsContent = '';
        
        // Try to ensure workout.summary is an object, not a string
        if (workout.summary && typeof workout.summary === 'string') {
            try {
                console.log("Summary is a string, parsing...");
                workout.summary = JSON.parse(workout.summary);
            } catch (e) {
                console.error("Failed to parse summary JSON:", e);
                workout.summary = {};
            }
        }
        
        // Set defaults if summary is missing or null
        if (!workout.summary) {
            workout.summary = {};
        }
        
        // Get workout type and format for display
        const workoutType = workout.workout_type || "Unknown";
        const workoutTypeFormatted = workoutType.charAt(0).toUpperCase() + workoutType.slice(1);
        
        // Format start time
        const startTime = new Date(workout.start_time);
        const dateTimeOptions = { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        const formattedDate = startTime.toLocaleDateString(undefined, dateTimeOptions);
        
        // Format duration
        const duration = workout.duration || 0;
        const durationFormatted = formatDuration(duration);
        
        // Get summary metrics with defaults for missing values
        const summary = workout.summary || {};
        const totalDistance = summary.total_distance || 0;
        const totalCalories = summary.total_calories || 0;
        const avgPower = summary.avg_power || 0;
        const maxPower = summary.max_power || 0;
        const avgHeartRate = summary.avg_heart_rate || 0;
        const maxHeartRate = summary.max_heart_rate || 0;
        
        console.log("Summary data:", summary);
        
        // Build header section
        detailsContent += `
            <div class="workout-header mb-4">
                <h3>${workoutTypeFormatted} Workout <span class="text-muted">#${workout.id}</span></h3>
                <div class="workout-meta">
                    <div><i class="far fa-calendar-alt"></i> ${formattedDate}</div>
                    <div><i class="far fa-clock"></i> ${durationFormatted}</div>
                    <div><i class="fas fa-route"></i> ${totalDistance.toFixed(2)} m</div>
                </div>
            </div>
        `;
        
        // Build summary section
        detailsContent += `
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="summary-stat">
                                        <span class="summary-label">Distance</span>
                                        <span class="summary-value">${totalDistance.toFixed(2)} m</span>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="summary-stat">
                                        <span class="summary-label">Duration</span>
                                        <span class="summary-value">${durationFormatted}</span>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="summary-stat">
                                        <span class="summary-label">Calories</span>
                                        <span class="summary-value">${Math.round(totalCalories)} kcal</span>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="summary-stat">
                                        <span class="summary-label">Avg Power</span>
                                        <span class="summary-value">${Math.round(avgPower)} W</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">`;
        
        // Add workout type specific metrics
        if (workout.workout_type === 'bike') {
            const avgCadence = summary.avg_cadence || 0;
            const maxCadence = summary.max_cadence || 0;
            const avgSpeed = summary.avg_speed || 0;
            const maxSpeed = summary.max_speed || 0;
            
            detailsContent += `
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="summary-stat">
                        <span class="summary-label">Max Power</span>
                        <span class="summary-value">${Math.round(maxPower)} W</span>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="summary-stat">
                        <span class="summary-label">Avg Cadence</span>
                        <span class="summary-value">${Math.round(avgCadence)} rpm</span>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="summary-stat">
                        <span class="summary-label">Max Cadence</span>
                        <span class="summary-value">${Math.round(maxCadence)} rpm</span>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="summary-stat">
                        <span class="summary-label">Avg Speed</span>
                        <span class="summary-value">${avgSpeed.toFixed(1)} km/h</span>
                    </div>
                </div>`;
        } else if (workout.workout_type === 'rower') {
            const avgStrokeRate = summary.avg_stroke_rate || 0;
            const maxStrokeRate = summary.max_stroke_rate || 0;
            const totalStrokes = summary.total_strokes || 0;
            
            detailsContent += `
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="summary-stat">
                        <span class="summary-label">Max Power</span>
                        <span class="summary-value">${Math.round(maxPower)} W</span>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="summary-stat">
                        <span class="summary-label">Avg Stroke Rate</span>
                        <span class="summary-value">${Math.round(avgStrokeRate)} spm</span>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="summary-stat">
                        <span class="summary-label">Max Stroke Rate</span>
                        <span class="summary-value">${Math.round(maxStrokeRate)} spm</span>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="summary-stat">
                        <span class="summary-label">Total Strokes</span>
                        <span class="summary-value">${totalStrokes}</span>
                    </div>
                </div>`;
        }
        
        // Add heart rate metrics
        if (avgHeartRate > 0 || maxHeartRate > 0) {
            detailsContent += `
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="summary-stat">
                        <span class="summary-label">Avg Heart Rate</span>
                        <span class="summary-value">${Math.round(avgHeartRate)} bpm</span>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="summary-stat">
                        <span class="summary-label">Max Heart Rate</span>
                        <span class="summary-value">${Math.round(maxHeartRate)} bpm</span>
                    </div>
                </div>`;
        }
        
        // Close summary section
        detailsContent += `
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add charts if there are data points
        if (workout.data_series && workout.data_series.timestamps && workout.data_series.timestamps.length > 0) {
            detailsContent += `
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5>Power</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="powerChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5>${workout.workout_type === 'bike' ? 'Cadence' : 'Stroke Rate'}</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="cadenceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5>Heart Rate</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="heartRateChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5>Distance</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="distanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            detailsContent += `<div class="alert alert-info">No workout data points available for charts.</div>`;
        }
        
        // Add export buttons
        detailsContent += `
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Export</h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary me-2" id="exportFitBtn">
                                <i class="fas fa-file-export"></i> Export as FIT
                            </button>
                            <button class="btn btn-secondary me-2" id="exportCsvBtn">
                                <i class="fas fa-file-csv"></i> Export as CSV
                            </button>
                            <button class="btn btn-success" id="uploadGarminBtn">
                                <i class="fas fa-upload"></i> Upload to Garmin Connect
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Set the HTML and show the modal
        workoutDetails.innerHTML = detailsContent;
        
        // Set up chart data if available
        if (workout.data_series && workout.data_series.timestamps && workout.data_series.timestamps.length > 0) {
            setupCharts(workout);
        }
        
        // Set up export buttons
        document.getElementById('exportFitBtn').addEventListener('click', function() {
            exportWorkoutToFit(workout.id);
        });
        
        document.getElementById('exportCsvBtn').addEventListener('click', function() {
            alert('CSV export is not implemented yet');
        });
        
        document.getElementById('uploadGarminBtn').addEventListener('click', function() {
            alert('Garmin Connect upload is not implemented yet');
        });
    }
    
    // Set up charts for workout visualization
    function setupCharts(workout) {
        // Extract data series
        const timestamps = workout.data_series.timestamps || [];
        const powers = workout.data_series.powers || [];
        const cadences = workout.data_series.cadences || [];
        const heartRates = workout.data_series.heart_rates || [];
        const distances = workout.data_series.distances || [];
        
        // Format timestamps for display
        const timeLabels = timestamps.map(formatTimestamp);
        
        // Create power chart
        const powerCtx = document.getElementById('powerChart').getContext('2d');
        new Chart(powerCtx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Power (watts)',
                    data: powers,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderWidth: 2,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Power (W)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time (min:sec)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                return `Time: ${tooltipItems[0].label}`;
                            }
                        }
                    }
                }
            }
        });
        
        // Create cadence/stroke rate chart
        const cadenceCtx = document.getElementById('cadenceChart').getContext('2d');
        const cadenceLabel = workout.workout_type === 'bike' ? 'Cadence (rpm)' : 'Stroke Rate (spm)';
        const cadenceYAxisLabel = workout.workout_type === 'bike' ? 'Cadence (rpm)' : 'Stroke Rate (spm)';
        
        new Chart(cadenceCtx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: cadenceLabel,
                    data: cadences,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderWidth: 2,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: cadenceYAxisLabel
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time (min:sec)'
                        }
                    }
                }
            }
        });
        
        // Create heart rate chart if data is available
        const hasHeartRateData = heartRates.some(hr => hr > 0);
        
        if (hasHeartRateData) {
            const heartRateCtx = document.getElementById('heartRateChart').getContext('2d');
            new Chart(heartRateCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Heart Rate (bpm)',
                        data: heartRates,
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        borderWidth: 2,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Heart Rate (bpm)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (min:sec)'
                            }
                        }
                    }
                }
            });
        } else {
            // If no heart rate data, display a message
            const heartRateContainer = document.getElementById('heartRateChart').parentNode;
            heartRateContainer.innerHTML = '<div class="alert alert-info my-3">No heart rate data available for this workout.</div>';
        }
        
        // Create distance chart
        const distanceCtx = document.getElementById('distanceChart').getContext('2d');
        new Chart(distanceCtx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Distance (m)',
                    data: distances,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 2,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Distance (m)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time (min:sec)'
                        }
                    }
                }
            }
        });
    }

    // Export workout to FIT file
    function exportWorkoutToFit(workoutId) {
        const exportBtn = document.getElementById('exportFitBtn');
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
        exportBtn.disabled = true;
        
        fetch(`/api/convert_fit/${workoutId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            exportBtn.innerHTML = '<i class="fas fa-file-export"></i> Export as FIT';
            exportBtn.disabled = false;
            
            if (data.success && data.fit_file_path) {
                // Create a download link for the FIT file
                const downloadLink = document.createElement('a');
                downloadLink.href = `/fit_files/${data.fit_file_name}`;
                downloadLink.download = data.fit_file_name;
                downloadLink.click();
                
                // Show success message
                alert(`FIT file created successfully: ${data.fit_file_name}`);
            } else {
                alert(`Error creating FIT file: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            exportBtn.innerHTML = '<i class="fas fa-file-export"></i> Export as FIT';
            exportBtn.disabled = false;
            alert(`Error creating FIT file: ${error.message}`);
        });
    }

    // Delete a workout
    function deleteWorkout(workoutId) {
        fetch(`/api/workout/${workoutId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the workout from the list
                document.querySelector(`tr[data-workout-id="${workoutId}"]`).remove();
                
                // Clear workout details if this was the selected workout
                if (document.querySelector('#workout-details').innerHTML.includes(`Workout <span class="text-muted">#${workoutId}</span>`)) {
                    document.querySelector('#workout-details').innerHTML = '<p>Select a workout to view details.</p>';
                }
                
                // Update all workouts list
                loadAllWorkouts();
                
                // Show success message
                alert('Workout deleted successfully');
            } else {
                alert(`Error deleting workout: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error deleting workout: ${error.message}`);
        });
    }

    // Upload to Garmin
    function uploadToGarmin(workoutId) {
        alert('Garmin Connect upload functionality is not yet implemented.');
    }

    // Load user preferences
    function loadUserPreferences() {
        // First try to get from settings
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.settings && data.settings.unit_system) {
                    userUnitSystem = data.settings.unit_system;
                    console.log("Loaded unit preference from settings:", userUnitSystem);
                } else {
                    // If not in settings, try user profile
                    return fetch('/api/user_profile');
                }
            })
            .then(response => {
                if (response) return response.json();
            })
            .then(data => {
                if (data && data.success && data.profile && data.profile.unit_preference) {
                    userUnitSystem = data.profile.unit_preference;
                    console.log("Loaded unit preference from profile:", userUnitSystem);
                }
            })
            .catch(error => {
                console.error('Error loading user preferences:', error);
            });
    }
    
    // Initialize on document load
    document.addEventListener('DOMContentLoaded', function() {
        // Load initial data
        loadAllWorkouts();
        loadUserPreferences(); // Load user preferences
        
        // Set up sorting change event
        sortBySelect.addEventListener('change', function() {
            currentPage = 1; // Reset to first page when sort changes
            applySort();
        });
        
        // Set up pagination
        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                applySort(); // Apply sorting with new page
            }
        });
        
        nextPageBtn.addEventListener('click', function() {
            const totalPages = Math.ceil(totalWorkouts / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                applySort(); // Apply sorting with new page
            }
        });
        
        // Check if a workout ID is specified in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const workoutId = urlParams.get('workout_id');
        
        if (workoutId) {
            // Load details for the specified workout
            loadWorkoutDetails(workoutId);
        }
    });
</script>
{% endblock %}