{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Workout History</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Recent Workouts</h5>
                            <div class="sorting-controls">
                                <label for="sort-by" class="me-2">Sort by:</label>
                                <select id="sort-by" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                                    <option value="date-desc">Date (newest first)</option>
                                    <option value="date-asc">Date (oldest first)</option>
                                    <option value="duration-desc">Duration (longest first)</option>
                                    <option value="duration-asc">Duration (shortest first)</option>
                                    <option value="distance-desc">Distance (longest first)</option>
                                    <option value="distance-asc">Distance (shortest first)</option>
                                    <option value="calories-desc">Calories (highest first)</option>
                                    <option value="calories-asc">Calories (lowest first)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="workouts-list">
                            <p>Loading workouts...</p>
                        </div>
                        <div id="pagination" class="mt-3">
                            <button id="prev-page-btn" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                            <span id="page-info" class="mx-2">Page 1</span>
                            <button id="next-page-btn" class="btn btn-sm btn-outline-primary" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Workout Details</h5>
                    </div>
                    <div class="card-body">
                        <div id="workout-details">
                            <p>Select a workout to view details.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM elements
    const workoutsList = document.getElementById("workouts-list");
    const workoutDetails = document.getElementById("workout-details");
    const prevPageBtn = document.getElementById("prev-page-btn");
    const nextPageBtn = document.getElementById("next-page-btn");
    const pageInfo = document.getElementById("page-info");
    const sortBySelect = document.getElementById("sort-by");
    
    // Pagination and sorting state
    let currentPage = 1;
    const pageSize = 10;
    let totalWorkouts = 0;
    let currentSort = "date-desc"; // Default sort
    let allWorkouts = []; // Store all loaded workouts for client-side sorting
    
    // User"s unit preference (will be loaded from settings)
    let userUnitSystem = "metric";
    
    // Unit conversion utilities
    const unitConversions = {
        // Distance conversions
        mToMi: (m) => m / 1609.34,
        miToM: (mi) => mi * 1609.34,
        mToKm: (m) => m / 1000,
        kmToM: (km) => km * 1000,
        
        // Speed conversions
        msToKph: (ms) => ms * 3.6,
        msToMph: (ms) => ms * 2.23694,
        kphToMph: (kph) => kph * 0.621371,
        mphToKph: (mph) => mph / 0.621371
    };
    
    // Format duration function
    function formatDuration(seconds) {
        if (!seconds || isNaN(seconds)) return "-";
        
        seconds = Math.round(seconds);
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        return [
            hours.toString().padStart(2, "0"),
            minutes.toString().padStart(2, "0"),
            secs.toString().padStart(2, "0")
        ].join(":");
    }
    
    // Format timestamp for chart labels
    function formatTimestamp(seconds) {
        if (!seconds || isNaN(seconds)) return "";
        
        seconds = Math.round(seconds);
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        
        return `${minutes}:${secs.toString().padStart(2, "0")}`;
    }
    
    // Sort workouts based on the selected sort option
    function sortWorkouts(workouts, sortOption) {
        const [field, direction] = sortOption.split("-");
        const directionMultiplier = direction === "asc" ? 1 : -1;
        
        return [...workouts].sort((a, b) => {
            let valueA, valueB;
            
            switch (field) {
                case "date":
                    // Convert dates to timestamps for comparison
                    valueA = a.start_time ? new Date(a.start_time).getTime() : 0;
                    valueB = b.start_time ? new Date(b.start_time).getTime() : 0;
                    break;
                    
                case "duration":
                    valueA = a.duration || 0;
                    valueB = b.duration || 0;
                    break;
                    
                case "distance":
                    // Extract distance from summary or default to 0
                    valueA = (a.summary && a.summary.total_distance) ? a.summary.total_distance : 0;
                    valueB = (b.summary && b.summary.total_distance) ? b.summary.total_distance : 0;
                    break;
                    
                case "calories":
                    // Extract calories from summary or default to 0
                    valueA = (a.summary && a.summary.total_calories) ? a.summary.total_calories : 0;
                    valueB = (b.summary && b.summary.total_calories) ? b.summary.total_calories : 0;
                    break;
                    
                default:
                    return 0;
            }
            
            return directionMultiplier * (valueA - valueB);
        });
    }
    
    // Load and display all workouts
    function loadAllWorkouts() {
        workoutsList.innerHTML = 	"<p><i class=\"fas fa-spinner fa-spin\"></i> Loading workouts...</p>";
        
        console.log("Fetching workouts from /api/workouts...");
        
        fetch("/api/workouts")
            .then(response => {
                console.log("Response status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("Workouts API full response:", data); // Enhanced debug output
                
                if (data.success && data.workouts && data.workouts.length > 0) {
                    console.log(`Successfully loaded ${data.workouts.length} workouts`);
                    // Store all workouts
                    allWorkouts = data.workouts;
                    
                    // Apply sorting and display the first page
                    applySort();
                } else if (data.success && (!data.workouts || data.workouts.length === 0)) {
                    console.log("No workouts found in the response");
                    workoutsList.innerHTML = 	"<div class=\"alert alert-info\">No workouts found. Start tracking your workouts on the <a href=\"/workout\">Workout</a> page.</div>";
                    prevPageBtn.disabled = true;
                    nextPageBtn.disabled = true;
                } else {
                    console.error("Error in API response:", data);
                    workoutsList.innerHTML = `<div class=\"alert alert-danger\">Error loading workouts: ${data.error || "Unknown error"}</div>`;
                }
            })
            .catch(error => {
                console.error("Error fetching workouts:", error);
                workoutsList.innerHTML = `<div class=\"alert alert-danger\">Error loading workouts: ${error.message}</div>`;
            });
    }
    
    // Apply current sort option and show the appropriate page
    function applySort() {
        if (allWorkouts.length === 0) return;
        
        // Get sort option from the select element
        currentSort = sortBySelect.value;
        
        // Sort the workouts
        const sortedWorkouts = sortWorkouts(allWorkouts, currentSort);
        
        // Calculate pagination details
        totalWorkouts = sortedWorkouts.length;
        const totalPages = Math.ceil(totalWorkouts / pageSize);
        
        // Ensure currentPage is within valid range
        if (currentPage > totalPages) {
            currentPage = totalPages;
        }
        
        // Get the workouts for the current page
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, sortedWorkouts.length);
        const pagedWorkouts = sortedWorkouts.slice(startIndex, endIndex);
        
        // Display the workouts
        displayWorkouts(pagedWorkouts);
        
        // Update pagination controls
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage >= totalPages;
    }
    
    // Load workouts
    function loadWorkouts(page = 1) {
        const offset = (page - 1) * pageSize;
        
        workoutsList.innerHTML = 	"<p><i class=\"fas fa-spinner fa-spin\"></i> Loading workouts...</p>";
        
        fetch(`/api/workouts?limit=${pageSize}&offset=${offset}`)
            .then(response => response.json())
            .then(data => {
                console.log("Workouts API response:", data); // Debug output
                
                if (data.success) {
                    if (data.workouts && data.workouts.length > 0) {
                        displayWorkouts(data.workouts);
                        totalWorkouts = data.workouts.length;
                        
                        // Update pagination
                        currentPage = page;
                        pageInfo.textContent = `Page ${currentPage}`;
                        prevPageBtn.disabled = currentPage === 1;
                        nextPageBtn.disabled = data.workouts.length < pageSize;
                    } else {
                        workoutsList.innerHTML = 	"<div class=\"alert alert-info\">No workouts found. Start tracking your workouts on the <a href=\"/workout\">Workout</a> page.</div>";
                        prevPageBtn.disabled = true;
                        nextPageBtn.disabled = true;
                    }
                } else {
                    workoutsList.innerHTML = `<div class=\"alert alert-danger\">Error loading workouts: ${data.error || "Unknown error"}</div>`;
                }
            })
            .catch(error => {
                workoutsList.innerHTML = `<div class=\"alert alert-danger\">Error loading workouts: ${error.message}</div>`;
                console.error("Error loading workouts:", error);
            });
    }
    
    // Display workouts
    function displayWorkouts(workouts) {
        let html = 	"<div class=\"table-responsive\"><table class=\"table table-hover\">";
        html += `
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Duration</th>
                    <th>Distance</th>
                    <th>Calories</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        workouts.forEach(workout => {
            // Parse the start time with fallback handling
            let startTimeStr = "-";
            try {
                const startTime = workout.start_time ? new Date(workout.start_time) : new Date();
                startTimeStr = startTime.toLocaleString();
            } catch (e) {
                console.error("Error parsing start time:", e, workout.start_time);
            }
            
            // Safely extract summary values with fallbacks
            const duration = formatDuration(workout.duration);
            
            // Format distance with unit conversion based on user preference
            let distanceText = "-";
            if (workout.summary && workout.summary.total_distance) {
                const distanceM = workout.summary.total_distance;
                
                if (userUnitSystem === "imperial") {
                    // Convert meters to miles
                    const distanceMi = unitConversions.mToMi(distanceM);
                    distanceText = distanceMi.toFixed(2) + " mi";
                } else {
                    // Convert meters to kilometers
                    const distanceKm = unitConversions.mToKm(distanceM);
                    distanceText = distanceKm.toFixed(2) + " km";
                }
            }
            
            const calories = (workout.summary && workout.summary.total_calories) ? 
                Math.round(workout.summary.total_calories) + " kcal" : "-";
                
            const workoutType = workout.workout_type ? 
                workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1) : "Unknown";
            
            html += `
                <tr data-workout-id="${workout.id}" class="workout-row">
                    <td>${startTimeStr}</td>
                    <td>${workoutType}</td>
                    <td>${duration}</td>
                    <td>${distanceText}</td>
                    <td>${calories}</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-btn" data-workout-id="${workout.id}">View</button>
                        <button class="btn btn-sm btn-success fit-btn" data-workout-id="${workout.id}">FIT</button>
                        <!-- Upload to Garmin button removed due to 2FA requirements -->
                        <button class="btn btn-sm btn-danger delete-btn" data-workout-id="${workout.id}">Delete</button>
                    </td>
                </tr>
            `;
        });
        
        html += "</tbody></table></div>";
        workoutsList.innerHTML = html;
        
        // Add event listeners to buttons
        document.querySelectorAll(".view-btn").forEach(button => {
            button.addEventListener("click", function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                loadWorkoutDetails(workoutId);
                
                // Highlight selected row
                document.querySelectorAll(".workout-row").forEach(r => r.classList.remove("table-active"));
                this.closest("tr").classList.add("table-active");
            });
        });
        
        document.querySelectorAll(".fit-btn").forEach(button => {
            button.addEventListener("click", function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                convertToFIT(workoutId);
            });
        });
        
        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                const confirmDelete = confirm("Are you sure you want to delete this workout? This action cannot be undone.");
                if (confirmDelete) {
                    deleteWorkout(workoutId);
                }
            });
        });
        
        // Add event listener for row clicks (to view details)
        document.querySelectorAll(".workout-row").forEach(row => {
            row.addEventListener("click", function() {
                const workoutId = this.dataset.workoutId;
                loadWorkoutDetails(workoutId);
                
                // Highlight selected row
                document.querySelectorAll(".workout-row").forEach(r => r.classList.remove("table-active"));
                this.classList.add("table-active");
            });
        });
    }
    
    // Load and display details for a specific workout
    function loadWorkoutDetails(workoutId) {
        workoutDetails.innerHTML = 	"<p><i class=\"fas fa-spinner fa-spin\"></i> Loading details...</p>";
        
        fetch(`/api/workout/${workoutId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.workout) {
                    const workout = data.workout;
                    const workoutData = data.workout_data || []; // Ensure workout_data is an array
                    
                    let detailsHtml = `<h5>Workout on ${new Date(workout.start_time).toLocaleString()}</h5>`;
                    detailsHtml += `<p><strong>Type:</strong> ${workout.workout_type ? workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1) : "Unknown"}</p>`;
                    detailsHtml += `<p><strong>Duration:</strong> ${formatDuration(workout.duration)}</p>`;
                    
                    if (workout.summary) {
                        // Format distance with unit conversion
                        let distanceText = "-";
                        if (workout.summary.total_distance) {
                            const distanceM = workout.summary.total_distance;
                            if (userUnitSystem === "imperial") {
                                distanceText = unitConversions.mToMi(distanceM).toFixed(2) + " mi";
                            } else {
                                distanceText = unitConversions.mToKm(distanceM).toFixed(2) + " km";
                            }
                        }
                        detailsHtml += `<p><strong>Total Distance:</strong> ${distanceText}</p>`;
                        
                        // Format average speed with unit conversion
                        let avgSpeedText = "-";
                        if (workout.summary.average_speed) {
                            const avgSpeedMs = workout.summary.average_speed;
                            if (userUnitSystem === "imperial") {
                                avgSpeedText = unitConversions.msToMph(avgSpeedMs).toFixed(1) + " mph";
                            } else {
                                avgSpeedText = unitConversions.msToKph(avgSpeedMs).toFixed(1) + " km/h";
                            }
                        }
                        detailsHtml += `<p><strong>Average Speed:</strong> ${avgSpeedText}</p>`;
                        
                        detailsHtml += `<p><strong>Total Calories:</strong> ${workout.summary.total_calories ? Math.round(workout.summary.total_calories) + " kcal" : "-"}</p>`;
                        detailsHtml += `<p><strong>Average Power:</strong> ${workout.summary.average_power ? Math.round(workout.summary.average_power) + " W" : "-"}</p>`;
                        
                        if (workout.workout_type === "bike" || workout.workout_type === "cycling") {
                            detailsHtml += `<p><strong>Average Cadence:</strong> ${workout.summary.average_cadence ? Math.round(workout.summary.average_cadence) + " RPM" : "-"}</p>`;
                        } else if (workout.workout_type === "rower" || workout.workout_type === "rowing") {
                            detailsHtml += `<p><strong>Average Stroke Rate:</strong> ${workout.summary.average_stroke_rate ? Math.round(workout.summary.average_stroke_rate) + " spm" : "-"}</p>`;
                        }
                    }
                    
                    // Add chart if data is available
                    if (workoutData.length > 0) {
                        detailsHtml += 	"<div style=\"height: 300px;\"><canvas id=\"workoutChart\"></canvas></div>";
                    }
                    
                    workoutDetails.innerHTML = detailsHtml;
                    
                    // Render chart if data is available
                    if (workoutData.length > 0) {
                        renderWorkoutChart(workoutData, workout.workout_type);
                    }
                    
                } else {
                    workoutDetails.innerHTML = `<div class="alert alert-danger">Error loading workout details: ${data.error || "Unknown error"}</div>`;
                }
            })
            .catch(error => {
                workoutDetails.innerHTML = `<div class="alert alert-danger">Error loading workout details: ${error.message}</div>`;
                console.error("Error loading workout details:", error);
            });
    }
    
    // Render workout chart
    let currentChart = null;
    function renderWorkoutChart(workoutData, workoutType) {
        const ctx = document.getElementById("workoutChart").getContext("2d");
        
        // Destroy previous chart instance if it exists
        if (currentChart) {
            currentChart.destroy();
        }
        
        // Prepare chart data
        const labels = workoutData.map(d => formatTimestamp(d.timestamp_offset)); // Use offset for x-axis
        const datasets = [];
        
        // Power data (always include if available)
        if (workoutData.some(d => d.power !== null && d.power !== undefined)) {
            datasets.push({
                label: "Power (W)",
                data: workoutData.map(d => d.power),
                borderColor: "rgba(255, 99, 132, 1)",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                yAxisID: "yPower",
                fill: false,
                tension: 0.1
            });
        }
        
        // Speed data (convert based on preference)
        if (workoutData.some(d => d.speed !== null && d.speed !== undefined)) {
            let speedData;
            let speedLabel = "Speed";
            if (userUnitSystem === "imperial") {
                speedData = workoutData.map(d => d.speed ? unitConversions.msToMph(d.speed) : null);
                speedLabel = "Speed (mph)";
            } else {
                speedData = workoutData.map(d => d.speed ? unitConversions.msToKph(d.speed) : null);
                speedLabel = "Speed (km/h)";
            }
            datasets.push({
                label: speedLabel,
                data: speedData,
                borderColor: "rgba(54, 162, 235, 1)",
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                yAxisID: "ySpeed",
                fill: false,
                tension: 0.1
            });
        }
        
        // Cadence or Stroke Rate data
        if (workoutType === "bike" || workoutType === "cycling") {
            if (workoutData.some(d => d.cadence !== null && d.cadence !== undefined)) {
                datasets.push({
                    label: "Cadence (RPM)",
                    data: workoutData.map(d => d.cadence),
                    borderColor: "rgba(75, 192, 192, 1)",
                    backgroundColor: "rgba(75, 192, 192, 0.2)",
                    yAxisID: "yCadence",
                    fill: false,
                    tension: 0.1
                });
            }
        } else if (workoutType === "rower" || workoutType === "rowing") {
            if (workoutData.some(d => d.stroke_rate !== null && d.stroke_rate !== undefined)) {
                datasets.push({
                    label: "Stroke Rate (spm)",
                    data: workoutData.map(d => d.stroke_rate),
                    borderColor: "rgba(153, 102, 255, 1)",
                    backgroundColor: "rgba(153, 102, 255, 0.2)",
                    yAxisID: "yCadence", // Reuse cadence axis for stroke rate
                    fill: false,
                    tension: 0.1
                });
            }
        }
        
        // Heart Rate data
        if (workoutData.some(d => d.heart_rate !== null && d.heart_rate !== undefined)) {
            datasets.push({
                label: "Heart Rate (bpm)",
                data: workoutData.map(d => d.heart_rate),
                borderColor: "rgba(255, 159, 64, 1)",
                backgroundColor: "rgba(255, 159, 64, 0.2)",
                yAxisID: "yHeartRate",
                fill: false,
                tension: 0.1
            });
        }
        
        // Configure chart options
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: "Time (min:sec)"
                    }
                },
                yPower: {
                    type: "linear",
                    display: true,
                    position: "left",
                    title: {
                        display: true,
                        text: "Power (W)"
                    },
                    grid: {
                        drawOnChartArea: false // Only display grid for the first Y axis
                    }
                },
                ySpeed: {
                    type: "linear",
                    display: true,
                    position: "right",
                    title: {
                        display: true,
                        text: userUnitSystem === "imperial" ? "Speed (mph)" : "Speed (km/h)"
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                yCadence: {
                    type: "linear",
                    display: true,
                    position: "right",
                    title: {
                        display: true,
                        text: (workoutType === "bike" || workoutType === "cycling") ? "Cadence (RPM)" : "Stroke Rate (spm)"
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                yHeartRate: {
                    type: "linear",
                    display: true,
                    position: "right",
                    title: {
                        display: true,
                        text: "Heart Rate (bpm)"
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: "index",
                    intersect: false
                }
            }
        };
        
        // Create the chart
        currentChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: datasets
            },
            options: chartOptions
        });
    }
    
    // Convert workout to FIT file
    function convertToFIT(workoutId) {
        // Show a loading indicator or disable the button
        const fitButton = document.querySelector(`.fit-btn[data-workout-id="${workoutId}"]`);
        const originalButtonText = fitButton.innerHTML;
        fitButton.innerHTML = 	"<i class=\"fas fa-spinner fa-spin\"></i> Generating...";
        fitButton.disabled = true;
        
        fetch(`/api/workout/${workoutId}/fit`)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || "FIT generation failed") });
                }
                // Get filename from Content-Disposition header
                const disposition = response.headers.get("Content-Disposition");
                let filename = "workout.fit"; // Default filename
                if (disposition && disposition.indexOf("attachment") !== -1) {
                    const filenameRegex = /filename[^;=\n]*=(([""])([^\"\n]*)\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[3]) {
                        filename = matches[3];
                    }
                }
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.style.display = "none";
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Restore button
                fitButton.innerHTML = originalButtonText;
                fitButton.disabled = false;
                
                // Show success message (optional)
                showToast("FIT file generated and download started.", "success");
            })
            .catch(error => {
                console.error("Error converting to FIT:", error);
                // Restore button
                fitButton.innerHTML = originalButtonText;
                fitButton.disabled = false;
                // Show error message
                showToast(`Error generating FIT: ${error.message}`, "error");
            });
    }
    
    // Delete workout
    function deleteWorkout(workoutId) {
        fetch(`/api/workout/${workoutId}`, { method: "DELETE" })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast("Workout deleted successfully.", "success");
                    // Reload workouts to reflect deletion
                    loadAllWorkouts(); 
                    // Clear details if the deleted workout was shown
                    if (document.querySelector(".workout-row.table-active[data-workout-id=\"" + workoutId + "\"]")) {
                        workoutDetails.innerHTML = "<p>Select a workout to view details.</p>";
                    }
                } else {
                    showToast(`Error deleting workout: ${data.error || "Unknown error"}`, "error");
                }
            })
            .catch(error => {
                showToast(`Error deleting workout: ${error.message}`, "error");
                console.error("Error deleting workout:", error);
            });
    }
    
    // Load user settings to get unit preference
    function loadUserSettings() {
        fetch("/api/user/profile")
            .then(response => response.json())
            .then(data => {
                if (data.success && data.profile && data.profile.unit_system) {
                    userUnitSystem = data.profile.unit_system;
                    console.log("User unit system loaded:", userUnitSystem);
                } else {
                    console.warn("Could not load user unit preference, defaulting to metric.");
                    userUnitSystem = "metric"; // Default if not found
                }
                // After loading settings, load workouts
                loadAllWorkouts();
            })
            .catch(error => {
                console.error("Error fetching user profile for unit system:", error);
                userUnitSystem = "metric"; // Default on error
                loadAllWorkouts();
            });
    }
    
    // Event listeners for pagination and sorting
    prevPageBtn.addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            applySort();
        }
    });
    
    nextPageBtn.addEventListener("click", () => {
        const totalPages = Math.ceil(totalWorkouts / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            applySort();
        }
    });
    
    sortBySelect.addEventListener("change", () => {
        currentPage = 1; // Reset to first page on sort change
        applySort();
    });
    
    // Initial load
    loadUserSettings(); // Load settings first, then workouts

</script>
{% endblock %}

