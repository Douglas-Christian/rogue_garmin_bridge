
{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Workout History</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Recent Workouts</h5>
                            <div class="sorting-controls">
                                <label for="sort-by" class="me-2">Sort by:</label>
                                <select id="sort-by" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                                    <option value="date-desc">Date (newest first)</option>
                                    <option value="date-asc">Date (oldest first)</option>
                                    <option value="duration-desc">Duration (longest first)</option>
                                    <option value="duration-asc">Duration (shortest first)</option>
                                    <option value="distance-desc">Distance (longest first)</option>
                                    <option value="distance-asc">Distance (shortest first)</option>
                                    <option value="calories-desc">Calories (highest first)</option>
                                    <option value="calories-asc">Calories (lowest first)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="workouts-list">
                            <p>Loading workouts...</p>
                        </div>
                        <div id="pagination" class="mt-3">
                            <button id="prev-page-btn" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                            <span id="page-info" class="mx-2">Page 1</span>
                            <button id="next-page-btn" class="btn btn-sm btn-outline-primary" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Workout Details</h5>
                    </div>
                    <div class="card-body">
                        <div id="workout-details">
                            <p>Select a workout to view details.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check if Chart.js is loaded
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded! Charts will not work.');
        } else {
            console.log('Chart.js loaded successfully, version:', Chart.version);
        }
    });
    
    // DOM elements
    const workoutsList = document.getElementById("workouts-list");
    const workoutDetails = document.getElementById("workout-details");
    const prevPageBtn = document.getElementById("prev-page-btn");
    const nextPageBtn = document.getElementById("next-page-btn");
    const pageInfo = document.getElementById("page-info");
    const sortBySelect = document.getElementById("sort-by");
    
    // Pagination and sorting state
    let currentPage = 1;
    const pageSize = 10;
    let totalWorkouts = 0;
    let currentSort = "date-desc"; // Default sort
    let allWorkouts = []; // Store all loaded workouts for client-side sorting
    
    // User's unit preference (will be loaded from settings)
    let userUnitSystem = "metric"; // Default to metric, can be loaded from user settings
    
    // Unit conversion utilities
    const unitConversions = {
        // Distance conversions
        mToMi: (m) => m / 1609.34,     // meters to miles
        miToM: (mi) => mi * 1609.34,   // miles to meters
        mToKm: (m) => m / 1000,        // meters to kilometers
        kmToM: (km) => km * 1000,      // kilometers to meters
        
        // Speed conversions
        msToKph: (ms) => ms * 3.6,     // meters/second to kilometers/hour
        msToMph: (ms) => ms * 2.23694, // meters/second to miles/hour
        kphToMph: (kph) => kph * 0.621371, // kilometers/hour to miles/hour
        mphToKph: (mph) => mph / 0.621371  // miles/hour to kilometers/hour
    };
    
    // Format duration function
    function formatDuration(seconds) {
        if (seconds === null || seconds === undefined || isNaN(seconds)) return "-";
        seconds = Math.round(seconds);
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
    }
    
    // Format timestamp for chart labels
    function formatTimestamp(seconds) {
        if (seconds === null || seconds === undefined || isNaN(seconds)) return "";
        seconds = Math.round(seconds);
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${minutes}:${secs.toString().padStart(2, "0")}`;
    }

    function checkChartJsLoaded() {
        try {
            if (typeof Chart !== 'undefined') {
                console.log("HISTORY_DEBUG: Chart.js is properly loaded, version:", Chart.version);
                return true;
            } else {
                console.error("HISTORY_DEBUG: Chart.js is not loaded or not defined");
                return false;
            }
        } catch (e) {
            console.error("HISTORY_DEBUG: Error checking Chart.js:", e);
            return false;
        }
    }
    
    function sortWorkouts(workouts, sortOption) {
        const [field, direction] = sortOption.split("-");
        const directionMultiplier = direction === "asc" ? 1 : -1;
        return [...workouts].sort((a, b) => {
            let valueA, valueB;
            switch (field) {
                case "date":
                    valueA = a.start_time ? new Date(a.start_time).getTime() : 0;
                    valueB = b.start_time ? new Date(b.start_time).getTime() : 0;
                    break;
                case "duration":
                    valueA = a.duration_seconds || 0; // Ensure using duration_seconds from workout_info
                    valueB = b.duration_seconds || 0;
                    break;
                case "distance":
                    valueA = (a.summary && a.summary.total_distance) ? parseFloat(a.summary.total_distance) : 0;
                    valueB = (b.summary && b.summary.total_distance) ? parseFloat(b.summary.total_distance) : 0;
                    break;
                case "calories":
                    valueA = (a.summary && a.summary.total_calories) ? parseInt(a.summary.total_calories) : 0;
                    valueB = (b.summary && b.summary.total_calories) ? parseInt(b.summary.total_calories) : 0;
                    break;
                default: return 0;
            }
            return directionMultiplier * (valueA - valueB);
        });
    }

    function loadAllWorkouts() {
        workoutsList.innerHTML = "<p><i class=\"fas fa-spinner fa-spin\"></i> Loading workouts...</p>";
        console.log("HISTORY_DEBUG: Fetching all workouts from /api/workouts...");
        fetch("/api/workouts") // Fetch all workouts
            .then(response => response.json())
            .then(data => {
                console.log("HISTORY_DEBUG: All Workouts API response:", data);
                if (data.success && data.workouts) {
                    allWorkouts = data.workouts.map(w => {
                        // Ensure summary is parsed if it's a string
                        if (w.summary && typeof w.summary === 'string') {
                            try { w.summary = JSON.parse(w.summary); } catch (e) { console.error('Error parsing summary for workout', w.id, e); w.summary = {}; }
                        }
                        return w;
                    });
                    totalWorkouts = allWorkouts.length;
                    if (totalWorkouts > 0) {
                        applySort(); 
                    } else {
                        workoutsList.innerHTML = "<div class=\"alert alert-info\">No workouts found.</div>";
                        prevPageBtn.disabled = true;
                        nextPageBtn.disabled = true;
                    }
                } else {
                    workoutsList.innerHTML = `<div class=\"alert alert-danger\">Error loading workouts: ${data.error || "Unknown error"}</div>`;
                }
            })
            .catch(error => {
                console.error("HISTORY_DEBUG: Error fetching all workouts:", error);
                workoutsList.innerHTML = `<div class=\"alert alert-danger\">Error loading workouts: ${error.message}</div>`;
            });
    }

    function applySort() {
        if (allWorkouts.length === 0) return;
        currentSort = sortBySelect.value;
        console.log(`HISTORY_DEBUG: Applying sort: ${currentSort}`);
        const sortedWorkouts = sortWorkouts(allWorkouts, currentSort);
        const totalPages = Math.ceil(totalWorkouts / pageSize);
        currentPage = Math.max(1, Math.min(currentPage, totalPages)); // Ensure current page is valid
        const startIndex = (currentPage - 1) * pageSize;
        const pagedWorkouts = sortedWorkouts.slice(startIndex, startIndex + pageSize);
        displayWorkouts(pagedWorkouts);
        pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage >= totalPages;
    }
    
    function displayWorkouts(workouts) {
        console.log("HISTORY_DEBUG: Displaying workouts:", workouts);
        let html = "<div class=\"table-responsive\"><table class=\"table table-hover\"><thead><tr><th>Date</th><th>Type</th><th>Duration</th><th>Distance</th><th>Calories</th><th>Actions</th></tr></thead><tbody>";
        if (!workouts || workouts.length === 0) {
            html += "<tr><td colspan=\"6\">No workouts to display for this page.</td></tr>";
        } else {
            workouts.forEach(workout => {
                let startTimeStr = "-";
                try { startTimeStr = workout.start_time ? new Date(workout.start_time).toLocaleString() : "-"; } catch (e) { console.error("Error parsing start time:", e, workout.start_time); }
                const duration = formatDuration(workout.duration_seconds);
                let distanceText = "-";
                if (workout.summary && workout.summary.total_distance !== undefined) {
                    const distanceM = parseFloat(workout.summary.total_distance);
                    distanceText = userUnitSystem === "imperial" ? `${unitConversions.mToMi(distanceM).toFixed(2)} mi` : `${unitConversions.mToKm(distanceM).toFixed(2)} km`;
                }
                const calories = (workout.summary && workout.summary.total_calories !== undefined) ? `${Math.round(parseFloat(workout.summary.total_calories))} kcal` : "-";
                const workoutType = workout.type ? workout.type.charAt(0).toUpperCase() + workout.type.slice(1) : "Unknown";
                html += `<tr data-workout-id="${workout.id}" class="workout-row"><td>${startTimeStr}</td><td>${workoutType}</td><td>${duration}</td><td>${distanceText}</td><td>${calories}</td><td><button class=\"btn btn-sm btn-primary view-btn\" data-workout-id="${workout.id}">View</button> <button class=\"btn btn-sm btn-success fit-btn\" data-workout-id="${workout.id}">FIT</button> <button class=\"btn btn-sm btn-danger delete-btn\" data-workout-id="${workout.id}">Delete</button></td></tr>`;
            });
        }
        html += "</tbody></table></div>";
        workoutsList.innerHTML = html;
    }

    function loadWorkoutDetails(workoutId) {
        console.log(`HISTORY_DEBUG: loadWorkoutDetails called for workout ID: ${workoutId}`);
        if (!checkChartJsLoaded()) {
            workoutDetails.innerHTML = "<div class=\"alert alert-warning\">Chart.js is not loaded. Cannot display workout charts.</div>";
            return;
        }
        workoutDetails.innerHTML = "<p><i class=\"fas fa-spinner fa-spin\"></i> Loading workout details...</p>";
        fetch(`/api/workout/${workoutId}`)
            .then(response => response.json())
            .then(data => {
                console.log(`HISTORY_DEBUG: API response for /api/workout/${workoutId}:`, data);
                if (data.success && data.workout) {
                    // Extract workout data and info from the API response
                    const workoutData = [];
                    
                    // Process data from data_series if available
                    if (data.workout.data_series) {
                        const series = data.workout.data_series;
                        const timestamps = series.timestamps || [];
                        
                        // Create a data point for each timestamp with the corresponding metrics
                        for (let i = 0; i < timestamps.length; i++) {
                            workoutData.push({
                                timestamp: timestamps[i],
                                data: {
                                    power: series.powers ? series.powers[i] : null,
                                    cadence: series.cadences ? series.cadences[i] : null,
                                    heart_rate: series.heart_rates ? series.heart_rates[i] : null,
                                    speed: series.speeds ? series.speeds[i] : null,
                                    distance: series.distances ? series.distances[i] : null
                                }
                            });
                        }
                    }
                    
                    // The workout info is the workout object itself
                    displayWorkoutDetails(workoutData, data.workout);
                } else {
                    console.error("HISTORY_DEBUG: Error in API response or missing data for workout details:", data.error);
                    workoutDetails.innerHTML = `<div class=\"alert alert-danger\">Error loading workout details: ${data.error || "Unknown error or missing data"}</div>`;
                }
            })
            .catch(error => {
                console.error(`HISTORY_DEBUG: Fetch error for /api/workout/${workoutId}:`, error);
                workoutDetails.innerHTML = `<div class=\"alert alert-danger\">Error loading workout details: ${error.message}</div>`;
            });
    }

    function displayWorkoutDetails(workoutData, workoutInfo) {
        console.log("HISTORY_DEBUG: displayWorkoutDetails called with workoutData:", workoutData, "workoutInfo:", workoutInfo);
        let summaryHtml = `<h5>Workout Summary (ID: ${workoutInfo.id})</h5>`;
        let summary = {};
        if (workoutInfo.summary && typeof workoutInfo.summary === 'string') {
            try { summary = JSON.parse(workoutInfo.summary); } catch (e) { console.error("HISTORY_DEBUG: Error parsing workoutInfo.summary JSON:", e, workoutInfo.summary); }
        } else if (workoutInfo.summary && typeof workoutInfo.summary === 'object') {
            summary = workoutInfo.summary; // Already an object
        }
        console.log("HISTORY_DEBUG: Parsed summary for display:", summary);

        const displayDistanceM = summary.total_distance !== undefined ? parseFloat(summary.total_distance) : (workoutInfo.total_distance !== undefined ? parseFloat(workoutInfo.total_distance) : 0);
        const displayDistance = userUnitSystem === "imperial" ? `${unitConversions.mToMi(displayDistanceM).toFixed(2)} mi` : `${unitConversions.mToKm(displayDistanceM).toFixed(2)} km`;
        
        // The speed values from the summary are stored in km/h (not m/s), so use correct conversion
        const displayAvgSpeedKph = summary.avg_speed !== undefined ? parseFloat(summary.avg_speed) : 0;
        const displayAvgSpeed = userUnitSystem === "imperial" ? 
            `${unitConversions.kphToMph(displayAvgSpeedKph).toFixed(1)} mph` : 
            `${displayAvgSpeedKph.toFixed(1)} kph`;
            
        const displayMaxSpeedKph = summary.max_speed !== undefined ? parseFloat(summary.max_speed) : 0;
        const displayMaxSpeed = userUnitSystem === "imperial" ? 
            `${unitConversions.kphToMph(displayMaxSpeedKph).toFixed(1)} mph` : 
            `${displayMaxSpeedKph.toFixed(1)} kph`;

        summaryHtml += `<p><strong>Type:</strong> ${workoutInfo.type || '-'}<br>
                          <strong>Start Time:</strong> ${workoutInfo.start_time ? new Date(workoutInfo.start_time).toLocaleString() : '-'}<br>
                          <strong>Duration:</strong> ${formatDuration(workoutInfo.duration_seconds)}<br>
                          <strong>Total Distance:</strong> ${displayDistance}<br>
                          <strong>Avg Speed:</strong> ${displayAvgSpeed}<br>
                          <strong>Max Speed:</strong> ${displayMaxSpeed}<br>
                          <strong>Avg Power:</strong> ${summary.avg_power !== undefined ? Math.round(summary.avg_power) : '-'} W<br>
                          <strong>Max Power:</strong> ${summary.max_power !== undefined ? Math.round(summary.max_power) : '-'} W<br>
                          <strong>Avg Cadence:</strong> ${summary.avg_cadence !== undefined ? Math.round(summary.avg_cadence) : '-'} RPM<br>
                          <strong>Max Cadence:</strong> ${summary.max_cadence !== undefined ? Math.round(summary.max_cadence) : '-'} RPM<br>
                          <strong>Avg Heart Rate:</strong> ${summary.avg_heart_rate !== undefined ? Math.round(summary.avg_heart_rate) : '-'} bpm<br>
                          <strong>Max Heart Rate:</strong> ${summary.max_heart_rate !== undefined ? Math.round(summary.max_heart_rate) : '-'} bpm<br>
                          <strong>Calories:</strong> ${summary.total_calories !== undefined ? Math.round(summary.total_calories) : '-'} kcal</p>`;
        
        workoutDetails.innerHTML = summaryHtml;
        const chartContainer = document.createElement('div');
        chartContainer.id = "workout-chart-container";
        const canvas = document.createElement('canvas');
        canvas.id = "workoutChart";
        chartContainer.appendChild(canvas);
        workoutDetails.appendChild(chartContainer);

        console.log("HISTORY_DEBUG: Preparing chart data. Number of data points:", workoutData.length);
        if (workoutData.length === 0) {
            console.warn("HISTORY_DEBUG: No data points available for chart.");
            chartContainer.innerHTML = "<p class='text-muted'>No detailed data points to chart.</p>";
            return;
        }

        const dataSeries = { timestamps: [], speeds: [], powers: [], cadences: [], heart_rates: [] };
        let firstTimestampMs = null;
        try { firstTimestampMs = workoutData[0] && workoutData[0].timestamp ? new Date(workoutData[0].timestamp).getTime() : null; } catch (e) { console.error("HISTORY_DEBUG: Error parsing first data point timestamp:", e); }

        workoutData.forEach(dp => {
            let currentTimestampMs = null;
            try { currentTimestampMs = dp.timestamp ? new Date(dp.timestamp).getTime() : null; } catch (e) { console.error("HISTORY_DEBUG: Error parsing data point timestamp:", e); }
            dataSeries.timestamps.push(firstTimestampMs && currentTimestampMs ? (currentTimestampMs - firstTimestampMs) / 1000 : 0);
            const pointData = dp.data || {};
            dataSeries.speeds.push(pointData.speed !== undefined ? parseFloat(pointData.speed) : null);
            dataSeries.powers.push(pointData.power !== undefined ? parseInt(pointData.power) : null);
            dataSeries.cadences.push(pointData.cadence !== undefined ? parseInt(pointData.cadence) : null);
            dataSeries.heart_rates.push(pointData.heart_rate !== undefined ? parseInt(pointData.heart_rate) : null);
        });
        console.log("HISTORY_DEBUG: Chart dataSeries prepared:", dataSeries);

        const datasets = [];
        if (dataSeries.speeds.some(s => s !== null)) datasets.push({ label: "Speed (m/s)", data: dataSeries.speeds, borderColor: "rgba(75, 192, 192, 1)", backgroundColor: "rgba(75, 192, 192, 0.2)", yAxisID: "ySpeed", fill: false, tension: 0.1 });
        if (dataSeries.powers.some(p => p !== null)) datasets.push({ label: "Power (W)", data: dataSeries.powers, borderColor: "rgba(255, 99, 132, 1)", backgroundColor: "rgba(255, 99, 132, 0.2)", yAxisID: "yPower", fill: false, tension: 0.1 });
        if (dataSeries.cadences.some(c => c !== null)) datasets.push({ label: "Cadence (RPM)", data: dataSeries.cadences, borderColor: "rgba(54, 162, 235, 1)", backgroundColor: "rgba(54, 162, 235, 0.2)", yAxisID: "yCadence", fill: false, tension: 0.1 });
        if (dataSeries.heart_rates.some(h => h !== null)) datasets.push({ label: "Heart Rate (bpm)", data: dataSeries.heart_rates, borderColor: "rgba(255, 159, 64, 1)", backgroundColor: "rgba(255, 159, 64, 0.2)", yAxisID: "yHeartRate", fill: false, tension: 0.1 });

        if (datasets.length === 0) {
            console.warn("HISTORY_DEBUG: No valid data series for chart.");
            chartContainer.innerHTML = "<p class='text-muted'>No chartable data found for this workout.</p>";
            return;
        }

        const config = {
            type: 'line',
            data: { labels: dataSeries.timestamps.map(formatTimestamp), datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, stacked: false,
                scales: {
                    x: { title: { display: true, text: 'Time (MM:SS)' } },
                    ySpeed: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Speed (m/s)' } },
                    yPower: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Power (W)' }, grid: { drawOnChartArea: false } },
                    yCadence: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Cadence (RPM)' }, grid: { drawOnChartArea: false }, suggestedMin: 0 },
                    yHeartRate: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Heart Rate (bpm)' }, grid: { drawOnChartArea: false }, suggestedMin: 40 }
                },
                plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } }
            }
        };
        console.log("HISTORY_DEBUG: Chart.js config:", config);

        try {
            if (window.workoutDetailChart instanceof Chart) window.workoutDetailChart.destroy();
            window.workoutDetailChart = new Chart(document.getElementById('workoutChart').getContext('2d'), config);
            console.log("HISTORY_DEBUG: Chart created successfully.");
        } catch (e) {
            console.error("HISTORY_DEBUG: Error creating chart:", e);
            chartContainer.innerHTML = "<p class='text-danger'>Error displaying chart.</p>";
        }
    }

    function downloadFitFile(workoutId) {
        console.log(`HISTORY_DEBUG: downloadFitFile called for workout ID: ${workoutId}`);
        // First, call API to ensure FIT file is generated/exists and get its path
        fetch(`/api/convert_fit/${workoutId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                console.log(`HISTORY_DEBUG: /api/convert_fit/${workoutId} response:`, data);
                if (data.success && data.fit_file_path) {
                    // The actual filename is the last part of the path
                    const filename = data.fit_file_path.split(/[\\/]/).pop();
                    // Trigger download by navigating to the file serving endpoint
                    window.location.href = `/fit_files/${filename}`;
                    showNotification(`Downloading FIT file: ${filename}`, 'success');
                } else {
                    showNotification(`Error preparing FIT file: ${data.error || 'Unknown error'}`, 'danger');
                }
            })
            .catch(error => {
                console.error(`HISTORY_DEBUG: Error in /api/convert_fit/${workoutId}:`, error);
                showNotification(`Error preparing FIT file: ${error.message}`, 'danger');
            });
    }

    function deleteWorkout(workoutId) {
        console.log(`HISTORY_DEBUG: deleteWorkout called for workout ID: ${workoutId}`);
        if (!confirm(`Are you sure you want to delete workout ID ${workoutId}? This action cannot be undone.`)) return;
        fetch(`/api/workout/${workoutId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                console.log(`HISTORY_DEBUG: /api/workout/${workoutId} DELETE response:`, data);
                if (data.success) {
                    showNotification(`Workout ${workoutId} deleted successfully.`, 'success');
                    loadAllWorkouts(); // Refresh the list
                    workoutDetails.innerHTML = "<p>Select a workout to view details.</p>"; // Clear details view
                } else {
                    showNotification(`Error deleting workout: ${data.error || 'Unknown error'}`, 'danger');
                }
            })
            .catch(error => {
                console.error(`HISTORY_DEBUG: Error deleting workout ${workoutId}:`, error);
                showNotification(`Error deleting workout: ${error.message}`, 'danger');
            });
    }

    // Initial load and event listeners setup
    sortBySelect.addEventListener("change", applySort);
    prevPageBtn.addEventListener("click", () => { if (!prevPageBtn.disabled) { currentPage--; applySort(); } });
    nextPageBtn.addEventListener("click", () => { if (!nextPageBtn.disabled) { currentPage++; applySort(); } });
    
    workoutsList.addEventListener("click", function(event) {
        const target = event.target;
        // Traverse up if the click was on an icon inside a button
        const button = target.closest('button'); 
        if (!button) return;

        const workoutId = button.dataset.workoutId;
        if (!workoutId) return;

        console.log(`HISTORY_DEBUG: Button clicked inside workoutsList. Workout ID: ${workoutId}, Classes: ${button.className}`);

        if (button.classList.contains("view-btn")) {
            loadWorkoutDetails(workoutId);
        } else if (button.classList.contains("fit-btn")) {
            downloadFitFile(workoutId);
        } else if (button.classList.contains("delete-btn")) {
            deleteWorkout(workoutId);
        }
    });

    // Load user settings (e.g., unit preference) - Placeholder
    // fetch('/api/settings').then(res => res.json()).then(data => {
    //     if (data.success && data.settings && data.settings.unit_system) {
    //         userUnitSystem = data.settings.unit_system;
    //     }
    //     loadAllWorkouts(); // Initial load after settings
    // }).catch(() => loadAllWorkouts()); 
    loadAllWorkouts(); // Initial load

    // Helper function for notifications if main.js is not properly loaded
    function showNotification(message, type = 'info') {
        console.log(`HISTORY_DEBUG: Notification - ${type}: ${message}`);
        
        // Check if the global showNotification exists first
        if (typeof window.showNotification === 'function') {
            window.showNotification(message, type);
            return;
        }
        
        // Create our own notification if the global one isn't available
        // Check if notification container exists
        let container = document.getElementById('notification-container');
        
        // Create container if it doesn't exist
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.role = 'alert';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Add to container
        container.appendChild(notification);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 150);
        }, 5000);
    }
;
</script>
{% endblock %}

