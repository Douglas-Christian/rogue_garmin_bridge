{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Workout History</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Recent Workouts</h5>
                            <div class="sorting-controls">
                                <label for="sor        // Heart Rate data
        if (dataSeries.heart_rates && dataSeries.heart_rates.length > 0) {
            datasets.push({
                label: "Heart Rate (bpm)",
                data: dataSeries.heart_rates,
                borderColor: "rgba(255, 159, 64, 1)",
                backgroundColor: "rgba(255, 159, 64, 0.2)",
                yAxisID: "yHeartRate",
                fill: false,
                tension: 0.1
            });
        }"me-2">Sort by:</label>
                                <select id="sort-by" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                                    <option value="date-desc">Date (newest first)</option>
                                    <option value="date-asc">Date (oldest first)</option>
                                    <option value="duration-desc">Duration (longest first)</option>
                                    <option value="duration-asc">Duration (shortest first)</option>
                                    <option value="distance-desc">Distance (longest first)</option>
                                    <option value="distance-asc">Distance (shortest first)</option>
                                    <option value="calories-desc">Calories (highest first)</option>
                                    <option value="calories-asc">Calories (lowest first)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="workouts-list">
                            <p>Loading workouts...</p>
                        </div>
                        <div id="pagination" class="mt-3">
                            <button id="prev-page-btn" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                            <span id="page-info" class="mx-2">Page 1</span>
                            <button id="next-page-btn" class="btn btn-sm btn-outline-primary" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Workout Details</h5>
                    </div>
                    <div class="card-body">
                        <div id="workout-details">
                            <p>Select a workout to view details.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check if Chart.js is loaded
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded! Charts will not work.');
        } else {
            console.log('Chart.js loaded successfully, version:', Chart.version);
        }
    });
    
    // DOM elements
    const workoutsList = document.getElementById("workouts-list");
    const workoutDetails = document.getElementById("workout-details");
    const prevPageBtn = document.getElementById("prev-page-btn");
    const nextPageBtn = document.getElementById("next-page-btn");
    const pageInfo = document.getElementById("page-info");
    const sortBySelect = document.getElementById("sort-by");
    
    // Pagination and sorting state
    let currentPage = 1;
    const pageSize = 10;
    let totalWorkouts = 0;
    let currentSort = "date-desc"; // Default sort
    let allWorkouts = []; // Store all loaded workouts for client-side sorting
    
    // User"s unit preference (will be loaded from settings)
    let userUnitSystem = "metric";
    
    // Unit conversion utilities
    const unitConversions = {
        // Distance conversions
        mToMi: (m) => m / 1609.34,
        miToM: (mi) => mi * 1609.34,
        mToKm: (m) => m / 1000,
        kmToM: (km) => km * 1000,
        
        // Speed conversions
        msToKph: (ms) => ms * 3.6,
        msToMph: (ms) => ms * 2.23694,
        kphToMph: (kph) => kph * 0.621371,
        mphToKph: (mph) => mph / 0.621371
    };
    
    // Format duration function
    function formatDuration(seconds) {
        if (!seconds || isNaN(seconds)) return "-";
        
        seconds = Math.round(seconds);
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        return [
            hours.toString().padStart(2, "0"),
            minutes.toString().padStart(2, "0"),
            secs.toString().padStart(2, "0")
        ].join(":");
    }
    
    // Format timestamp for chart labels
    function formatTimestamp(seconds) {
        if (!seconds || isNaN(seconds)) return "";
        
        seconds = Math.round(seconds);
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        
        return `${minutes}:${secs.toString().padStart(2, "0")}`;
    }
    
    // Helper function to verify if Chart.js is properly loaded
    function checkChartJsLoaded() {
        try {
            if (typeof Chart !== 'undefined') {
                console.log("Chart.js is properly loaded, version:", Chart.version);
                return true;
            } else {
                console.error("Chart.js is not loaded or not defined");
                return false;
            }
        } catch (e) {
            console.error("Error checking Chart.js:", e);
            return false;
        }
    }
    
    // Sort workouts based on the selected sort option
    function sortWorkouts(workouts, sortOption) {
        const [field, direction] = sortOption.split("-");
        const directionMultiplier = direction === "asc" ? 1 : -1;
        
        return [...workouts].sort((a, b) => {
            let valueA, valueB;
            
            switch (field) {
                case "date":
                    // Convert dates to timestamps for comparison
                    valueA = a.start_time ? new Date(a.start_time).getTime() : 0;
                    valueB = b.start_time ? new Date(b.start_time).getTime() : 0;
                    break;
                    
                case "duration":
                    valueA = a.duration || 0;
                    valueB = b.duration || 0;
                    break;
                    
                case "distance":
                    // Extract distance from summary or default to 0
                    valueA = (a.summary && a.summary.total_distance) ? a.summary.total_distance : 0;
                    valueB = (b.summary && b.summary.total_distance) ? b.summary.total_distance : 0;
                    break;
                    
                case "calories":
                    // Extract calories from summary or default to 0
                    valueA = (a.summary && a.summary.total_calories) ? a.summary.total_calories : 0;
                    valueB = (b.summary && b.summary.total_calories) ? b.summary.total_calories : 0;
                    break;
                    
                default:
                    return 0;
            }
            
            return directionMultiplier * (valueA - valueB);
        });
    }
    
    // Load and display all workouts
    function loadAllWorkouts() {
        workoutsList.innerHTML = 	"<p><i class=\"fas fa-spinner fa-spin\"></i> Loading workouts...</p>";
        
        console.log("Fetching workouts from /api/workouts...");
        
        fetch("/api/workouts")
            .then(response => {
                console.log("Response status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("Workouts API full response:", data); // Enhanced debug output
                
                if (data.success && data.workouts && data.workouts.length > 0) {
                    console.log(`Successfully loaded ${data.workouts.length} workouts`);
                    // Store all workouts
                    allWorkouts = data.workouts;
                    
                    // Apply sorting and display the first page
                    applySort();
                } else if (data.success && (!data.workouts || data.workouts.length === 0)) {
                    console.log("No workouts found in the response");
                    workoutsList.innerHTML = 	"<div class=\"alert alert-info\">No workouts found. Start tracking your workouts on the <a href=\"/workout\">Workout</a> page.</div>";
                    prevPageBtn.disabled = true;
                    nextPageBtn.disabled = true;
                } else {
                    console.error("Error in API response:", data);
                    workoutsList.innerHTML = `<div class=\"alert alert-danger\">Error loading workouts: ${data.error || "Unknown error"}</div>`;
                }
            })
            .catch(error => {
                console.error("Error fetching workouts:", error);
                workoutsList.innerHTML = `<div class=\"alert alert-danger\">Error loading workouts: ${error.message}</div>`;
            });
    }
    
    // Apply current sort option and show the appropriate page
    function applySort() {
        if (allWorkouts.length === 0) return;
        
        // Get sort option from the select element
        currentSort = sortBySelect.value;
        
        // Sort the workouts
        const sortedWorkouts = sortWorkouts(allWorkouts, currentSort);
        
        // Calculate pagination details
        totalWorkouts = sortedWorkouts.length;
        const totalPages = Math.ceil(totalWorkouts / pageSize);
        
        // Ensure currentPage is within valid range
        if (currentPage > totalPages) {
            currentPage = totalPages;
        }
        
        // Get the workouts for the current page
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, sortedWorkouts.length);
        const pagedWorkouts = sortedWorkouts.slice(startIndex, endIndex);
        
        // Display the workouts
        displayWorkouts(pagedWorkouts);
        
        // Update pagination controls
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage >= totalPages;
    }
    
    // Load workouts
    function loadWorkouts(page = 1) {
        const offset = (page - 1) * pageSize;
        
        workoutsList.innerHTML = 	"<p><i class=\"fas fa-spinner fa-spin\"></i> Loading workouts...</p>";
        
        fetch(`/api/workouts?limit=${pageSize}&offset=${offset}`)
            .then(response => response.json())
            .then(data => {
                console.log("Workouts API response:", data); // Debug output
                
                if (data.success) {
                    if (data.workouts && data.workouts.length > 0) {
                        displayWorkouts(data.workouts);
                        totalWorkouts = data.workouts.length;
                        
                        // Update pagination
                        currentPage = page;
                        pageInfo.textContent = `Page ${currentPage}`;
                        prevPageBtn.disabled = currentPage === 1;
                        nextPageBtn.disabled = data.workouts.length < pageSize;
                    } else {
                        workoutsList.innerHTML = 	"<div class=\"alert alert-info\">No workouts found. Start tracking your workouts on the <a href=\"/workout\">Workout</a> page.</div>";
                        prevPageBtn.disabled = true;
                        nextPageBtn.disabled = true;
                    }
                } else {
                    workoutsList.innerHTML = `<div class=\"alert alert-danger\">Error loading workouts: ${data.error || "Unknown error"}</div>`;
                }
            })
            .catch(error => {
                workoutsList.innerHTML = `<div class=\"alert alert-danger\">Error loading workouts: ${error.message}</div>`;
                console.error("Error loading workouts:", error);
            });
    }
    
    // Display workouts
    function displayWorkouts(workouts) {
        let html = 	"<div class=\"table-responsive\"><table class=\"table table-hover\">";
        html += `
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Duration</th>
                    <th>Distance</th>
                    <th>Calories</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        workouts.forEach(workout => {
            // Parse the start time with fallback handling
            let startTimeStr = "-";
            try {
                const startTime = workout.start_time ? new Date(workout.start_time) : new Date();
                startTimeStr = startTime.toLocaleString();
            } catch (e) {
                console.error("Error parsing start time:", e, workout.start_time);
            }
            
            // Safely extract summary values with fallbacks
            const duration = formatDuration(workout.duration);
            
            // Format distance with unit conversion based on user preference
            let distanceText = "-";
            if (workout.summary && workout.summary.total_distance) {
                const distanceM = workout.summary.total_distance;
                
                if (userUnitSystem === "imperial") {
                    // Convert meters to miles
                    const distanceMi = unitConversions.mToMi(distanceM);
                    distanceText = distanceMi.toFixed(2) + " mi";
                } else {
                    // Convert meters to kilometers
                    const distanceKm = unitConversions.mToKm(distanceM);
                    distanceText = distanceKm.toFixed(2) + " km";
                }
            }
            
            const calories = (workout.summary && workout.summary.total_calories) ? 
                Math.round(workout.summary.total_calories) + " kcal" : "-";
                
            const workoutType = workout.workout_type ? 
                workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1) : "Unknown";
            
            html += `
                <tr data-workout-id="${workout.id}" class="workout-row">
                    <td>${startTimeStr}</td>
                    <td>${workoutType}</td>
                    <td>${duration}</td>
                    <td>${distanceText}</td>
                    <td>${calories}</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-btn" data-workout-id="${workout.id}">View</button>
                        <button class="btn btn-sm btn-success fit-btn" data-workout-id="${workout.id}">FIT</button>
                        <!-- Upload to Garmin button removed due to 2FA requirements -->
                        <button class="btn btn-sm btn-danger delete-btn" data-workout-id="${workout.id}">Delete</button>
                    </td>
                </tr>
            `;
        });
        
        html += "</tbody></table></div>";
        workoutsList.innerHTML = html;
        
        // Add event listeners to buttons
        document.querySelectorAll(".view-btn").forEach(button => {
            button.addEventListener("click", function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                loadWorkoutDetails(workoutId);
                
                // Highlight selected row
                document.querySelectorAll(".workout-row").forEach(r => r.classList.remove("table-active"));
                this.closest("tr").classList.add("table-active");
            });
        });
        
        document.querySelectorAll(".fit-btn").forEach(button => {
            button.addEventListener("click", function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                convertToFIT(workoutId);
            });
        });
        
        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", function(e) {
                e.stopPropagation(); // Prevent triggering row click
                const workoutId = this.dataset.workoutId;
                const confirmDelete = confirm("Are you sure you want to delete this workout? This action cannot be undone.");
                if (confirmDelete) {
                    deleteWorkout(workoutId);
                }
            });
        });
        
        // Add event listener for row clicks (to view details)
        document.querySelectorAll(".workout-row").forEach(row => {
            row.addEventListener("click", function() {
                const workoutId = this.dataset.workoutId;
                loadWorkoutDetails(workoutId);
                
                // Highlight selected row
                document.querySelectorAll(".workout-row").forEach(r => r.classList.remove("table-active"));
                this.classList.add("table-active");
            });
        });
    }
    
    // Load and display details for a specific workout
    function loadWorkoutDetails(workoutId) {
        workoutDetails.innerHTML = 	"<p><i class=\"fas fa-spinner fa-spin\"></i> Loading details...</p>";
        
        console.log(`Loading details for workout ${workoutId}...`);
        
        fetch(`/api/workout/${workoutId}`)
            .then(response => {
                console.log(`Got response for workout ${workoutId}, status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log(`Parsed JSON data for workout ${workoutId}:`, data);
                if (data.success && data.workout) {
                    const workout = data.workout;
                    console.log("Workout data received:", workout);
                    
                    // Debug information about the workout data structure
                    console.log("Workout summary:", workout.summary);
                    console.log("Data series exists:", !!workout.data_series);
                    if (workout.data_series) {
                        console.log("Data series powers length:", workout.data_series.powers ? workout.data_series.powers.length : 0);
                        console.log("Data series timestamps length:", workout.data_series.timestamps ? workout.data_series.timestamps.length : 0);
                    }
                    
                    let detailsHtml = `<h5>Workout on ${new Date(workout.start_time).toLocaleString()}</h5>`;
                    detailsHtml += `<p><strong>Type:</strong> ${workout.workout_type ? workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1) : "Unknown"}</p>`;
                    detailsHtml += `<p><strong>Duration:</strong> ${formatDuration(workout.duration)}</p>`;
                    
                    if (workout.summary) {
                        // Format distance with unit conversion
                        let distanceText = "-";
                        if (workout.summary.total_distance) {
                            const distanceM = workout.summary.total_distance;
                            if (userUnitSystem === "imperial") {
                                distanceText = unitConversions.mToMi(distanceM).toFixed(2) + " mi";
                            } else {
                                distanceText = unitConversions.mToKm(distanceM).toFixed(2) + " km";
                            }
                        }
                        detailsHtml += `<p><strong>Total Distance:</strong> ${distanceText}</p>`;
                        
                        // Format average speed with unit conversion
                        let avgSpeedText = "-";
                        // Check for both naming patterns (average_speed and avg_speed)
                        const avgSpeed = workout.summary.average_speed || workout.summary.avg_speed;
                        if (avgSpeed) {
                            const avgSpeedMs = avgSpeed;
                            if (userUnitSystem === "imperial") {
                                avgSpeedText = unitConversions.msToMph(avgSpeedMs).toFixed(1) + " mph";
                            } else {
                                avgSpeedText = unitConversions.msToKph(avgSpeedMs).toFixed(1) + " km/h";
                            }
                        }
                        detailsHtml += `<p><strong>Average Speed:</strong> ${avgSpeedText}</p>`;
                        
                        detailsHtml += `<p><strong>Total Calories:</strong> ${workout.summary.total_calories ? Math.round(workout.summary.total_calories) + " kcal" : "-"}</p>`;
                        
                        // Check for both naming patterns (average_power and avg_power)
                        const avgPower = workout.summary.average_power || workout.summary.avg_power || 0;
                        detailsHtml += `<p><strong>Average Power:</strong> ${avgPower ? Math.round(avgPower) + " W" : "-"}</p>`;
                        
                        if (workout.workout_type === "bike" || workout.workout_type === "cycling") {
                            // Check for both naming patterns (average_cadence and avg_cadence)
                            const avgCadence = workout.summary.average_cadence || workout.summary.avg_cadence || 0;
                            detailsHtml += `<p><strong>Average Cadence:</strong> ${avgCadence ? Math.round(avgCadence) + " RPM" : "-"}</p>`;
                        } else if (workout.workout_type === "rower" || workout.workout_type === "rowing") {
                            // Check for both naming patterns (average_stroke_rate and avg_stroke_rate)
                            const avgStrokeRate = workout.summary.average_stroke_rate || workout.summary.avg_stroke_rate || 0;
                            detailsHtml += `<p><strong>Average Stroke Rate:</strong> ${avgStrokeRate ? Math.round(avgStrokeRate) + " spm" : "-"}</p>`;
                        }
                    }
                    // Add additional metrics if available in summary
                    if (workout.summary) {
                        // Heart rate data (if available)
                        const avgHeartRate = workout.summary.average_heart_rate || workout.summary.avg_heart_rate;
                        if (avgHeartRate) {
                            detailsHtml += `<p><strong>Average Heart Rate:</strong> ${Math.round(avgHeartRate)} bpm</p>`;
                        }
                    }
                    
                    // Check if data_series exists for chart
                    const hasDataSeries = workout.data_series && (
                        (workout.data_series.powers && workout.data_series.powers.length > 0) ||
                        (workout.data_series.speeds && workout.data_series.speeds.length > 0) ||
                        (workout.data_series.heart_rates && workout.data_series.heart_rates.length > 0) ||
                        (workout.data_series.cadences && workout.data_series.cadences.length > 0)
                    );
                    
                    // Add chart container if data is available
                    if (hasDataSeries) {
                        detailsHtml += `<div style="height: 300px;"><canvas id="workoutChart"></canvas></div>`;
                    } else {
                        detailsHtml += `<div class="alert alert-info mt-3">No detailed data available for this workout.</div>`;
                    }
                    
                    workoutDetails.innerHTML = detailsHtml;
                    
                    // Render chart if data is available
                    if (hasDataSeries) {
                        // Create a properly formatted data series object if any arrays are missing
                        const dataSeries = {
                            powers: workout.data_series.powers || [],
                            cadences: workout.data_series.cadences || [],
                            heart_rates: workout.data_series.heart_rates || [],
                            speeds: workout.data_series.speeds || [],
                            distances: workout.data_series.distances || []
                        };
                        
                        renderWorkoutChart(dataSeries, workout.workout_type);
                    }
                    
                } else {
                    console.error("Error in workout details response:", data);
                    workoutDetails.innerHTML = `<div class="alert alert-danger">Error loading workout details: ${data.error || "Unknown error"}</div>`;
                }
            })
            .catch(error => {
                console.error("Exception loading workout details:", error);
                let errorDetails = "";
                if (error.stack) {
                    errorDetails = `<details><summary>Error details</summary><pre>${error.stack}</pre></details>`;
                }
                workoutDetails.innerHTML = `<div class="alert alert-danger">Error loading workout details: ${error.message}${errorDetails}</div>`;
            });
    }
    
    // Render workout chart
    let currentChart = null;
    function renderWorkoutChart(dataSeries, workoutType) {
        // Check if Chart.js is properly loaded
        if (!checkChartJsLoaded()) {
            const chartContainer = document.getElementById("workoutChart").parentNode;
            chartContainer.innerHTML = `<div class="alert alert-danger">Error: Chart.js is not loaded properly.</div>`;
            return;
        }
        
        const chartElement = document.getElementById("workoutChart");
        if (!chartElement) {
            console.error("Chart canvas element not found");
            return;
        }
        
        const ctx = chartElement.getContext("2d");
        if (!ctx) {
            console.error("Could not get 2d context from canvas");
            return;
        }
        
        // Destroy previous chart instance if it exists
        if (currentChart) {
            currentChart.destroy();
        }
        
        console.log("Rendering chart with data series:", dataSeries);
        
        // Calculate the data length from the longest available array
        const dataLengths = [
            dataSeries.powers ? dataSeries.powers.length : 0,
            dataSeries.cadences ? dataSeries.cadences.length : 0,
            dataSeries.heart_rates ? dataSeries.heart_rates.length : 0,
            dataSeries.speeds ? dataSeries.speeds.length : 0
        ];
        const dataLength = Math.max(...dataLengths);
        
        console.log("Chart data length:", dataLength);
        
        // Create sequential time labels based on the length of data
        const labels = [];
        for (let i = 0; i < dataLength; i++) {
            labels.push(formatTimestamp(i));
        }
        
        const datasets = [];
        
        // Power data (always include if available)
        if (dataSeries.powers && dataSeries.powers.length > 0) {
            datasets.push({
                label: "Power (W)",
                data: dataSeries.powers,
                borderColor: "rgba(255, 99, 132, 1)",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                yAxisID: "yPower",
                fill: false,
                tension: 0.1
            });
        }
        
        // Speed data (convert based on preference)
        if (dataSeries.speeds && dataSeries.speeds.length > 0) {
            let speedData;
            let speedLabel = "Speed";
            if (userUnitSystem === "imperial") {
                speedData = dataSeries.speeds.map(speed => speed ? unitConversions.msToMph(speed) : null);
                speedLabel = "Speed (mph)";
            } else {
                speedData = dataSeries.speeds.map(speed => speed ? unitConversions.msToKph(speed) : null);
                speedLabel = "Speed (km/h)";
            }
            datasets.push({
                label: speedLabel,
                data: speedData,
                borderColor: "rgba(54, 162, 235, 1)",
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                yAxisID: "ySpeed",
                fill: false,
                tension: 0.1
            });
        }
        
        // Cadence or Stroke Rate data
        if (workoutType === "bike" || workoutType === "cycling") {
            if (dataSeries.cadences && dataSeries.cadences.length > 0) {
                datasets.push({
                    label: "Cadence (RPM)",
                    data: dataSeries.cadences,
                    borderColor: "rgba(75, 192, 192, 1)",
                    backgroundColor: "rgba(75, 192, 192, 0.2)",
                    yAxisID: "yCadence",
                    fill: false,
                    tension: 0.1
                });
            }
        } else if (workoutType === "rower" || workoutType === "rowing") {
            // For rowers, check if stroke_rates array exists, otherwise fallback to cadences
            const strokeRateData = dataSeries.stroke_rates || dataSeries.cadences;
            if (strokeRateData && strokeRateData.length > 0) {
                datasets.push({
                    label: "Stroke Rate (spm)",
                    data: strokeRateData,
                    borderColor: "rgba(153, 102, 255, 1)",
                    backgroundColor: "rgba(153, 102, 255, 0.2)",
                    yAxisID: "yCadence", // Reuse cadence axis for stroke rate
                    fill: false,
                    tension: 0.1
                });
            }
        }
        
        // Heart Rate data
        if (dataSeries.heart_rates && dataSeries.heart_rates.length > 0) {
            datasets.push({
                label: "Heart Rate (bpm)",
                data: dataSeries.heart_rates,
                borderColor: "rgba(255, 159, 64, 1)",
                backgroundColor: "rgba(255, 159, 64, 0.2)",
                yAxisID: "yHeartRate",
                fill: false,
                tension: 0.1
            });
        }
        
        console.log("Creating chart with datasets:", datasets);
        
        // Configure chart options
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: "Time (min:sec)"
                    }
                },
                yPower: {
                    type: "linear",
                    display: true,
                    position: "left",
                    title: {
                        display: true,
                        text: "Power (W)"
                    },
                    grid: {
                        drawOnChartArea: false // Only display grid for the first Y axis
                    }
                },
                ySpeed: {
                    type: "linear",
                    display: true,
                    position: "right",
                    title: {
                        display: true,
                        text: userUnitSystem === "imperial" ? "Speed (mph)" : "Speed (km/h)"
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                yCadence: {
                    type: "linear",
                    display: true,
                    position: "right",
                    title: {
                        display: true,
                        text: (workoutType === "bike" || workoutType === "cycling") ? "Cadence (RPM)" : "Stroke Rate (spm)"
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                yHeartRate: {
                    type: "linear",
                    display: true,
                    position: "right",
                    title: {
                        display: true,
                        text: "Heart Rate (bpm)"
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: "index",
                    intersect: false
                }
            }
        };
        
        // Create the chart
        try {
            currentChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: chartOptions
            });
            console.log("Chart created successfully");
        } catch (error) {
            console.error("Error creating chart:", error);
            const chartContainer = document.getElementById("workoutChart").parentNode;
            chartContainer.innerHTML = `<div class="alert alert-danger">Error creating chart: ${error.message}</div>`;
        }
    }
    
    // Show a toast notification
    function showToast(message, type = "info") {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById("toast-container");
        if (!toastContainer) {
            toastContainer = document.createElement("div");
            toastContainer.id = "toast-container";
            toastContainer.className = "position-fixed bottom-0 end-0 p-3";
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastId = `toast-${Date.now()}`;
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} text-white">
                    <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        // Add toast to container
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Initialize and show toast
        const toastElement = document.getElementById(toastId);
        const bsToast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
        bsToast.show();
        
        // Remove toast after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function () {
            toastElement.remove();
        });
    }
    
    // Convert workout to FIT file
    function convertToFIT(workoutId) {
        if (!workoutId) {
            showToast("Error: No workout ID provided", "error");
            return;
        }
        
        // Show a loading toast
        showToast("Generating FIT file...", "info");
        
        // Create a temporary link to download the file
        const link = document.createElement('a');
        link.href = `/workout/${workoutId}/fit`;
        
        // Set a timeout to give the server time to generate the file
        setTimeout(() => {
            link.click();
        }, 100);
    }
    
    // Delete a workout
    function deleteWorkout(workoutId) {
        if (!workoutId) {
            showToast("Error: No workout ID provided", "error");
            return;
        }
        
        fetch(`/api/workout/${workoutId}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast("Workout deleted successfully", "success");
                    
                    // Reload workouts
                    loadAllWorkouts();
                    
                    // Clear workout details
                    workoutDetails.innerHTML = "<p>Select a workout to view details.</p>";
                    
                    // Destroy chart if exists
                    if (currentChart) {
                        currentChart.destroy();
                        currentChart = null;
                    }
                } else {
                    showToast(`Error deleting workout: ${data.error || "Unknown error"}`, "error");
                }
            })
            .catch(error => {
                showToast(`Error deleting workout: ${error.message}`, "error");
                console.error("Error deleting workout:", error);
            });
    }
    
    // Load user settings to get unit preference
    function loadUserSettings() {
        fetch("/api/user/profile")
            .then(response => response.json())
            .then(data => {
                if (data.success && data.profile && data.profile.unit_system) {
                    userUnitSystem = data.profile.unit_system;
                    console.log("User unit system loaded:", userUnitSystem);
                } else {
                    console.warn("Could not load user unit preference, defaulting to metric.");
                    userUnitSystem = "metric"; // Default if not found
                }
                // After loading settings, load workouts
                loadAllWorkouts();
            })
            .catch(error => {
                console.error("Error fetching user profile for unit system:", error);
                userUnitSystem = "metric"; // Default on error
                loadAllWorkouts();
            });
    }
    
    // Event listeners for pagination and sorting
    prevPageBtn.addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            applySort();
        }
    });
    
    nextPageBtn.addEventListener("click", () => {
        const totalPages = Math.ceil(totalWorkouts / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            applySort();
        }
    });
    
    sortBySelect.addEventListener("change", () => {
        currentPage = 1; // Reset to first page on sort change
        applySort();
    });
    
    // Initial load
    loadUserSettings(); // Load settings first, then workouts

</script>
{% endblock %}

