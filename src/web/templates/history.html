{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Workout History</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Recent Workouts</h5>
                    </div>
                    <div class="card-body">
                        <div id="workouts-list">
                            <p>Loading workouts...</p>
                        </div>
                        <div id="pagination" class="mt-3">
                            <button id="prev-page-btn" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                            <span id="page-info" class="mx-2">Page 1</span>
                            <button id="next-page-btn" class="btn btn-sm btn-outline-primary" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Workout Details</h5>
                    </div>
                    <div class="card-body">
                        <div id="workout-details">
                            <p>Select a workout to view details.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM elements
    const workoutsList = document.getElementById('workouts-list');
    const workoutDetails = document.getElementById('workout-details');
    const prevPageBtn = document.getElementById('prev-page-btn');
    const nextPageBtn = document.getElementById('next-page-btn');
    const pageInfo = document.getElementById('page-info');
    
    // Pagination
    let currentPage = 1;
    const pageSize = 10;
    let totalWorkouts = 0;
    
    // Load workouts
    function loadWorkouts(page = 1) {
        const offset = (page - 1) * pageSize;
        
        fetch(`/api/workouts?limit=${pageSize}&offset=${offset}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.workouts && data.workouts.length > 0) {
                        displayWorkouts(data.workouts);
                        totalWorkouts = data.workouts.length;
                        
                        // Update pagination
                        currentPage = page;
                        pageInfo.textContent = `Page ${currentPage}`;
                        prevPageBtn.disabled = currentPage === 1;
                        nextPageBtn.disabled = data.workouts.length < pageSize;
                    } else {
                        workoutsList.innerHTML = '<p>No workouts found.</p>';
                        prevPageBtn.disabled = true;
                        nextPageBtn.disabled = true;
                    }
                } else {
                    workoutsList.innerHTML = `<div class="alert alert-danger">Error loading workouts: ${data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                workoutsList.innerHTML = `<div class="alert alert-danger">Error loading workouts: ${error.message}</div>`;
                console.error('Error loading workouts:', error);
            });
    }
    
    // Display workouts
    function displayWorkouts(workouts) {
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += `
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Duration</th>
                    <th>Distance</th>
                    <th>Calories</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        workouts.forEach(workout => {
            const startTime = new Date(workout.start_time);
            const duration = workout.duration ? formatDuration(workout.duration) : '-';
            const distance = workout.summary && workout.summary.total_distance ? 
                Math.round(workout.summary.total_distance) + ' m' : '-';
            const calories = workout.summary && workout.summary.total_calories ? 
                Math.round(workout.summary.total_calories) + ' kcal' : '-';
            const workoutType = workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1);
            
            html += `
                <tr data-workout-id="${workout.id}" class="workout-row">
                    <td>${startTime.toLocaleString()}</td>
                    <td>${workoutType}</td>
                    <td>${duration}</td>
                    <td>${distance}</td>
                    <td>${calories}</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-btn" data-workout-id="${workout.id}">View</button>
                        <button class="btn btn-sm btn-success fit-btn" data-workout-id="${workout.id}">FIT</button>
                        <button class="btn btn-sm btn-info upload-btn" data-workout-id="${workout.id}">Upload</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        workoutsList.innerHTML = html;
        
        // Add event listeners to buttons
        document.querySelectorAll('.view-btn').forEach(button => {
            button.addEventListener('click', function() {
                const workoutId = this.dataset.workoutId;
                loadWorkoutDetails(workoutId);
            });
        });
        
        document.querySelectorAll('.fit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const workoutId = this.dataset.workoutId;
                convertToFIT(workoutId);
            });
        });
        
        document.querySelectorAll('.upload-btn').forEach(button => {
            button.addEventListener('click', function() {
                const workoutId = this.dataset.workoutId;
                uploadToGarmin(workoutId);
            });
        });
        
        // Add click event to rows
        document.querySelectorAll('.workout-row').forEach(row => {
            row.addEventListener('click', function() {
                const workoutId = this.dataset.workoutId;
                loadWorkoutDetails(workoutId);
                
                // Highlight selected row
                document.querySelectorAll('.workout-row').forEach(r => r.classList.remove('table-active'));
                this.classList.add('table-active');
            });
        });
    }
    
    // Load workout details
    function loadWorkoutDetails(workoutId) {
        workoutDetails.innerHTML = '<p>Loading workout details...</p>';
        
        fetch(`/api/workout/${workoutId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayWorkoutDetails(data.workout, data.processed_data);
                } else {
                    workoutDetails.innerHTML = `<div class="alert alert-danger">Error loading workout details: ${data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                workoutDetails.innerHTML = `<div class="alert alert-danger">Error loading workout details: ${error.message}</div>`;
                console.error('Error loading workout details:', error);
            });
    }
    
    // Display workout details
    function displayWorkoutDetails(workout, processedData) {
        const startTime = new Date(workout.start_time);
        const endTime = workout.end_time ? new Date(workout.end_time) : null;
        const duration = workout.duration ? formatDuration(workout.duration) : '-';
        const workoutType = workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1);
        
        let html = '<div class="row">';
        
        // Workout info
        html += `
            <div class="col-md-6">
                <h5>Workout Information</h5>
                <table class="table">
                    <tr>
                        <th>Date</th>
                        <td>${startTime.toLocaleString()}</td>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <td>${workoutType}</td>
                    </tr>
                    <tr>
                        <th>Duration</th>
                        <td>${duration}</td>
                    </tr>
                    <tr>
                        <th>Device</th>
                        <td>${workout.device_name || '-'}</td>
                    </tr>
                    <tr>
                        <th>FIT File</th>
                        <td>${workout.fit_file_path ? 
                            `<a href="/api/download_fit/${workout.id}" class="btn btn-sm btn-primary">Download</a>` : 
                            `<button class="btn btn-sm btn-secondary fit-btn" data-workout-id="${workout.id}">Generate</button>`
                        }</td>
                    </tr>
                    <tr>
                        <th>Uploaded to Garmin</th>
                        <td>${workout.uploaded_to_garmin ? 
                            '<span class="badge bg-success">Yes</span>' : 
                            `<button class="btn btn-sm btn-info upload-btn" data-workout-id="${workout.id}">Upload</button>`
                        }</td>
                    </tr>
                </table>
            </div>
        `;
        
        // Summary metrics
        html += '<div class="col-md-6">';
        html += '<h5>Summary Metrics</h5>';
        
        if (processedData) {
            html += '<table class="table">';
            
            // Add metrics based on workout type
            if (workout.workout_type === 'bike') {
                // Bike metrics
                if (processedData.avg_power !== undefined) {
                    html += `<tr><th>Avg Power</th><td>${Math.round(processedData.avg_power)} W</td></tr>`;
                }
                if (processedData.max_power !== undefined) {
                    html += `<tr><th>Max Power</th><td>${Math.round(processedData.max_power)} W</td></tr>`;
                }
                if (processedData.normalized_power !== undefined) {
                    html += `<tr><th>Normalized Power</th><td>${Math.round(processedData.normalized_power)} W</td></tr>`;
                }
                if (processedData.avg_cadence !== undefined) {
                    html += `<tr><th>Avg Cadence</th><td>${Math.round(processedData.avg_cadence)} rpm</td></tr>`;
                }
                if (processedData.avg_speed !== undefined) {
                    html += `<tr><th>Avg Speed</th><td>${processedData.avg_speed.toFixed(1)} km/h</td></tr>`;
                }
            } else if (workout.workout_type === 'rower') {
                // Rower metrics
                if (processedData.avg_power !== undefined) {
                    html += `<tr><th>Avg Power</th><td>${Math.round(processedData.avg_power)} W</td></tr>`;
                }
                if (processedData.max_power !== undefined) {
                    html += `<tr><th>Max Power</th><td>${Math.round(processedData.max_power)} W</td></tr>`;
                }
                if (processedData.avg_stroke_rate !== undefined) {
                    html += `<tr><th>Avg Stroke Rate</th><td>${Math.round(processedData.avg_stroke_rate)} spm</td></tr>`;
                }
                if (processedData.total_strokes !== undefined) {
                    html += `<tr><th>Total Strokes</th><td>${Math.round(processedData.total_strokes)}</td></tr>`;
                }
                if (processedData.avg_pace !== undefined) {
                    const minutes = Math.floor(processedData.avg_pace / 60);
                    const seconds = Math.round(processedData.avg_pace % 60);
                    html += `<tr><th>Avg Pace (500m)</th><td>${minutes}:${seconds.toString().padStart(2, '0')}</td></tr>`;
                }
            }
            
            // Common metrics
            if (processedData.avg_heart_rate !== undefined) {
                html += `<tr><th>Avg Heart Rate</th><td>${Math.round(processedData.avg_heart_rate)} bpm</td></tr>`;
            }
            if (processedData.max_heart_rate !== undefined) {
                html += `<tr><th>Max Heart Rate</th><td>${Math.round(processedData.max_heart_rate)} bpm</td></tr>`;
            }
            if (processedData.total_distance !== undefined) {
                html += `<tr><th>Total Distance</th><td>${Math.round(processedData.total_distance)} m</td></tr>`;
            }
            if (processedData.total_calories !== undefined) {
                html += `<tr><th>Total Calories</th><td>${Math.round(processedData.total_calories)} kcal</td></tr>`;
            }
            if (processedData.vo2max !== undefined) {
                html += `<tr><th>Estimated VO2 Max</th><td>${processedData.vo2max.toFixed(1)} ml/kg/min</td></tr>`;
            }
            
            html += '</table>';
        } else {
            html += '<p>No processed data available.</p>';
        }
        
        html += '</div>';
        html += '</div>';
        
        // Add chart if processed data is available
        if (processedData && processedData.data_series) {
            html += `
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5>Workout Chart</h5>
                        <div class="chart-container" style="position: relative; height:300px;">
                            <canvas id="workout-chart"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }
        
        workoutDetails.innerHTML = html;
        
        // Create chart if processed data is available
        if (processedData && processedData.data_series) {
            createWorkoutChart(processedData);
        }
        
        // Add event listeners to buttons
        document.querySelectorAll('.fit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const workoutId = this.dataset.workoutId;
                convertToFIT(workoutId);
            });
        });
        
        document.querySelectorAll('.upload-btn').forEach(button => {
            button.addEventListener('click', function() {
                const workoutId = this.dataset.workoutId;
                uploadToGarmin(workoutId);
            });
        });
    }
    
    // Create workout chart
    function createWorkoutChart(processedData) {
        const ctx = document.getElementById('workout-chart').getContext('2d');
        
        // Get data series
        const timestamps = processedData.data_series.timestamps || [];
        const powers = processedData.data_series.powers || [];
        const heartRates = processedData.data_series.heart_rates || [];
        
        // Create datasets
        const datasets = [];
        
        if (powers.length > 0) {
            datasets.push({
                label: 'Power (watts)',
                data: powers,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                yAxisID: 'y',
                fill: false
            });
        }
        
        if (heartRates.length > 0) {
            datasets.push({
                label: 'Heart Rate (bpm)',
                data: heartRates,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                yAxisID: 'y1',
                fill: true
            });
        }
        
        // Create the chart
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: datasets
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                stacked: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Workout Data'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Power (watts)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Heart Rate (bpm)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }
    
    // Convert workout to FIT
    function convertToFIT(workoutId) {
        fetch(`/api/convert_fit/${workoutId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`FIT file created successfully: ${data.fit_file_name}`);
                loadWorkoutDetails(workoutId);
               } else {
                alert(`Error creating FIT file: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error creating FIT file: ${error.message}`);
            console.error('Error creating FIT file:', error);
        });
    }
    
    // Upload workout to Garmin Connect
    function uploadToGarmin(workoutId) {
        fetch(`/api/upload_garmin/${workoutId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Workout uploaded successfully to Garmin Connect. Activity ID: ${data.activity_id}`);
                loadWorkoutDetails(workoutId);
            } else {
                alert(`Error uploading to Garmin Connect: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error uploading to Garmin Connect: ${error.message}`);
            console.error('Error uploading to Garmin Connect:', error);
        });
    }
</script>
{% endblock %}