{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Settings</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>User Profile</h5>
                    </div>
                    <div class="card-body">
                        <form id="user-profile-form">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name">
                            </div>
                            <div class="mb-3">
                                <label for="age" class="form-label">Age</label>
                                <input type="number" class="form-control" id="age" name="age" min="1" max="120">
                            </div>
                            <div class="mb-3">
                                <label for="weight" class="form-label">Weight (kg)</label>
                                <input type="number" class="form-control" id="weight" name="weight" min="1" max="300" step="0.1">
                            </div>
                            <div class="mb-3">
                                <label for="height" class="form-label">Height (cm)</label>
                                <input type="number" class="form-control" id="height" name="height" min="1" max="300">
                            </div>
                            <div class="mb-3">
                                <label for="gender" class="form-label">Gender</label>
                                <select class="form-select" id="gender" name="gender">
                                    <option value="">Select...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="max_heart_rate" class="form-label">Max Heart Rate (bpm)</label>
                                <input type="number" class="form-control" id="max_heart_rate" name="max_heart_rate" min="1" max="250">
                            </div>
                            <div class="mb-3">
                                <label for="resting_heart_rate" class="form-label">Resting Heart Rate (bpm)</label>
                                <input type="number" class="form-control" id="resting_heart_rate" name="resting_heart_rate" min="1" max="150">
                            </div>
                            <div class="mb-3">
                                <label for="ftp" class="form-label">Functional Threshold Power (watts)</label>
                                <input type="number" class="form-control" id="ftp" name="ftp" min="1" max="1000">
                            </div>
                            <button type="submit" class="btn btn-primary">Save Profile</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Garmin Connect Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="garmin-settings-form">
                            <div class="mb-3">
                                <label for="garmin_username" class="form-label">Garmin Connect Username</label>
                                <input type="text" class="form-control" id="garmin_username" name="garmin_username">
                            </div>
                            <div class="mb-3">
                                <label for="garmin_password" class="form-label">Garmin Connect Password</label>
                                <input type="password" class="form-control" id="garmin_password" name="garmin_password">
                                <div class="form-text">Your password is stored securely and only used for Garmin Connect uploads.</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Garmin Settings</button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Application Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="app-settings-form">
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="use_simulator" name="use_simulator">
                                <label class="form-check-label" for="use_simulator">Use Simulator</label>
                                <div class="form-text">Enable this option to use a simulator instead of real devices for testing.</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Save App Settings</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM elements
    const userProfileForm = document.getElementById('user-profile-form');
    const garminSettingsForm = document.getElementById('garmin-settings-form');
    const appSettingsForm = document.getElementById('app-settings-form');
    
    // Load user profile
    function loadUserProfile() {
        fetch('/api/user_profile')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.profile) {
                    // Populate form fields
                    const profile = data.profile;
                    
                    if (profile.name) document.getElementById('name').value = profile.name;
                    if (profile.age) document.getElementById('age').value = profile.age;
                    if (profile.weight) document.getElementById('weight').value = profile.weight;
                    if (profile.height) document.getElementById('height').value = profile.height;
                    if (profile.gender) document.getElementById('gender').value = profile.gender;
                    if (profile.max_heart_rate) document.getElementById('max_heart_rate').value = profile.max_heart_rate;
                    if (profile.resting_heart_rate) document.getElementById('resting_heart_rate').value = profile.resting_heart_rate;
                    if (profile.ftp) document.getElementById('ftp').value = profile.ftp;
                    if (profile.garmin_username) document.getElementById('garmin_username').value = profile.garmin_username;
                    if (profile.garmin_password) document.getElementById('garmin_password').value = profile.garmin_password;
                }
            })
            .catch(error => console.error('Error loading user profile:', error));
    }
    
    // Load app settings
    function loadAppSettings() {
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.settings) {
                    // Populate form fields
                    const settings = data.settings;
                    
                    if (settings.use_simulator !== undefined) {
                        document.getElementById('use_simulator').checked = settings.use_simulator;
                    }
                }
            })
            .catch(error => console.error('Error loading app settings:', error));
    }
    
    // Save user profile
    userProfileForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Get form data
        const formData = new FormData(userProfileForm);
        const profile = {};
        
        for (const [key, value] of formData.entries()) {
            if (value) {
                // Convert numeric values
                if (['age', 'max_heart_rate', 'resting_heart_rate', 'ftp'].includes(key)) {
                    profile[key] = parseInt(value);
                } else if (key === 'weight') {
                    profile[key] = parseFloat(value);
                } else if (key === 'height') {
                    profile[key] = parseInt(value);
                } else {
                    profile[key] = value;
                }
            }
        }
        
        // Save profile
        fetch('/api/user_profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(profile)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User profile saved successfully');
            } else {
                alert(`Error saving user profile: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error saving user profile: ${error.message}`);
            console.error('Error saving user profile:', error);
        });
    });
    
    // Save Garmin settings
    garminSettingsForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Get form data
        const formData = new FormData(garminSettingsForm);
        const settings = {};
        
        for (const [key, value] of formData.entries()) {
            if (value) {
                settings[key] = value;
            }
        }
        
        // Save settings
        fetch('/api/user_profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Garmin settings saved successfully');
            } else {
                alert(`Error saving Garmin settings: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error saving Garmin settings: ${error.message}`);
            console.error('Error saving Garmin settings:', error);
        });
    });
    
    // Save app settings
    appSettingsForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Get form data
        const settings = {
            use_simulator: document.getElementById('use_simulator').checked
        };
        
        // Save settings
        fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Application settings saved successfully');
            } else {
                alert(`Error saving application settings: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error saving application settings: ${error.message}`);
            console.error('Error saving application settings:', error);
        });
    });
    
    // Load settings on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadUserProfile();
        loadAppSettings();
    });
</script>
{% endblock %}
