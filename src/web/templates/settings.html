{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Settings</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>User Profile</h5>
                    </div>
                    <div class="card-body">
                        <form id="user-profile-form">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name">
                            </div>
                            <div class="mb-3">
                                <label for="age" class="form-label">Age</label>
                                <input type="number" class="form-control" id="age" name="age" min="1" max="120">
                            </div>
                            <div class="mb-3">
                                <label for="weight" class="form-label">Weight (kg)</label>
                                <input type="number" class="form-control" id="weight" name="weight" min="1" max="300" step="0.1">
                            </div>
                            <div class="mb-3">
                                <label for="height" class="form-label">Height (cm)</label>
                                <input type="number" class="form-control" id="height" name="height" min="1" max="300">
                            </div>
                            <div class="mb-3">
                                <label for="gender" class="form-label">Gender</label>
                                <select class="form-select" id="gender" name="gender">
                                    <option value="">Select...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="max_heart_rate" class="form-label">Max Heart Rate (bpm)</label>
                                <input type="number" class="form-control" id="max_heart_rate" name="max_heart_rate" min="1" max="250">
                            </div>
                            <div class="mb-3">
                                <label for="resting_heart_rate" class="form-label">Resting Heart Rate (bpm)</label>
                                <input type="number" class="form-control" id="resting_heart_rate" name="resting_heart_rate" min="1" max="150">
                            </div>
                            <div class="mb-3">
                                <label for="ftp" class="form-label">Functional Threshold Power (watts)</label>
                                <input type="number" class="form-control" id="ftp" name="ftp" min="1" max="1000">
                            </div>
                            <button type="submit" class="btn btn-primary">Save Profile</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Garmin Connect Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="garmin-settings-form">
                            <div class="mb-3">
                                <label for="garmin_username" class="form-label">Garmin Connect Username</label>
                                <input type="text" class="form-control" id="garmin_username" name="garmin_username">
                            </div>
                            <div class="mb-3">
                                <label for="garmin_password" class="form-label">Garmin Connect Password</label>
                                <input type="password" class="form-control" id="garmin_password" name="garmin_password">
                                <div class="form-text">Your password is stored securely and only used for Garmin Connect uploads.</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Garmin Settings</button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Application Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="app-settings-form">
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="use_simulator" name="use_simulator">
                                <label class="form-check-label" for="use_simulator">Use Simulator</label>
                                <div class="form-text">Enable this option to use a simulator instead of real devices for testing.</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Unit System Preference</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="unit_system_preference" id="metric_units" value="metric" checked>
                                    <label class="form-check-label" for="metric_units">
                                        Metric (kg, cm)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="unit_system_preference" id="imperial_units" value="imperial">
                                    <label class="form-check-label" for="imperial_units">
                                        Imperial (lbs, inches)
                                    </label>
                                </div>
                                <div class="form-text">Choose your preferred unit system for displaying measurements. This preference is saved with your user profile.</div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Save App Settings</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM elements
    const userProfileForm = document.getElementById('user-profile-form');
    const garminSettingsForm = document.getElementById('garmin-settings-form');
    const appSettingsForm = document.getElementById('app-settings-form');
    
    // Unit conversion utilities
    const unitConversions = {
        kgToLbs: (kg) => kg * 2.20462,
        lbsToKg: (lbs) => lbs / 2.20462,
        cmToInches: (cm) => cm / 2.54,
        inchesToCm: (inches) => inches * 2.54,
        // Other conversions (kmToMiles, etc.) can be added if needed elsewhere
    };
    
    let originalMetricWeight = null;
    let originalMetricHeight = null;
    let currentUnitSystem = 'metric'; // Default, will be updated from profile

    // Update form labels and values based on unit system
    function updateUnitDisplay(newUnitSystem) {
        currentUnitSystem = newUnitSystem;

        const weightLabel = document.querySelector('label[for="weight"]');
        const weightInput = document.getElementById('weight');
        const heightLabel = document.querySelector('label[for="height"]');
        const heightInput = document.getElementById('height');

        if (originalMetricWeight !== null && !isNaN(originalMetricWeight)) {
            if (newUnitSystem === 'imperial') {
                weightInput.value = unitConversions.kgToLbs(originalMetricWeight).toFixed(1);
                weightLabel.textContent = 'Weight (lbs)';
                weightInput.step = '0.1';
                weightInput.min = '1';
                weightInput.max = '660';
            } else { // Metric
                weightInput.value = originalMetricWeight.toFixed(1);
                weightLabel.textContent = 'Weight (kg)';
                weightInput.step = '0.1';
                weightInput.min = '1';
                weightInput.max = '300';
            }
        } else {
             // If no original metric weight, clear or set to default label based on system
            weightInput.value = '';
            weightLabel.textContent = newUnitSystem === 'imperial' ? 'Weight (lbs)' : 'Weight (kg)';
        }

        if (originalMetricHeight !== null && !isNaN(originalMetricHeight)) {
            if (newUnitSystem === 'imperial') {
                heightInput.value = unitConversions.cmToInches(originalMetricHeight).toFixed(0);
                heightLabel.textContent = 'Height (inches)';
                heightInput.min = '1';
                heightInput.max = '120'; 
            } else { // Metric
                heightInput.value = originalMetricHeight.toFixed(0);
                heightLabel.textContent = 'Height (cm)';
                heightInput.min = '1';
                heightInput.max = '300';
            }
        } else {
            // If no original metric height, clear or set to default label based on system
            heightInput.value = '';
            heightLabel.textContent = newUnitSystem === 'imperial' ? 'Height (inches)' : 'Height (cm)';
        }
    }
    
    // Handle unit system preference change
    document.querySelectorAll('input[name="unit_system_preference"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateUnitDisplay(this.value);
        });
    });
    
    // Load user profile
    function loadUserProfile() {
        fetch('/api/user_profile')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.profile) {
                    const profile = data.profile;
                    
                    if (profile.name) document.getElementById('name').value = profile.name;
                    if (profile.age) document.getElementById('age').value = profile.age;
                    
                    if (profile.weight !== undefined && profile.weight !== null) {
                        originalMetricWeight = parseFloat(profile.weight);
                    } else {
                        originalMetricWeight = null;
                    }
                    // Display initially in metric, updateUnitDisplay will convert if needed
                    document.getElementById('weight').value = originalMetricWeight !== null ? originalMetricWeight.toFixed(1) : '';

                    if (profile.height !== undefined && profile.height !== null) {
                        originalMetricHeight = parseFloat(profile.height);
                    } else {
                        originalMetricHeight = null;
                    }
                    document.getElementById('height').value = originalMetricHeight !== null ? originalMetricHeight.toFixed(0) : '';
                    
                    if (profile.gender) document.getElementById('gender').value = profile.gender;
                    if (profile.max_heart_rate) document.getElementById('max_heart_rate').value = profile.max_heart_rate;
                    if (profile.resting_heart_rate) document.getElementById('resting_heart_rate').value = profile.resting_heart_rate;
                    if (profile.ftp) document.getElementById('ftp').value = profile.ftp;
                    if (profile.garmin_username) document.getElementById('garmin_username').value = profile.garmin_username;
                    // Do NOT load garmin_password for security reasons.
                    
                    let preferredUnitSystem = 'metric'; // Default
                    if (profile.unit_preference) {
                        preferredUnitSystem = profile.unit_preference;
                    }
                    currentUnitSystem = preferredUnitSystem;
                    const unitRadio = document.getElementById(`${preferredUnitSystem}_units`);
                    if (unitRadio) {
                        unitRadio.checked = true;
                    }
                    updateUnitDisplay(preferredUnitSystem); // This will convert and display based on preference

                } else if (data.success && !data.profile) {
                    // No profile exists, set defaults
                    originalMetricWeight = null;
                    originalMetricHeight = null;
                    document.getElementById('weight').value = '';
                    document.getElementById('height').value = '';
                    document.getElementById('metric_units').checked = true;
                    currentUnitSystem = 'metric';
                    updateUnitDisplay('metric'); // Ensure labels are metric
                }
            })
            .catch(error => console.error('Error loading user profile:', error));
    }
    
    // Load app settings (now only for non-unit related settings like use_simulator)
    function loadAppSettings() {
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.settings) {
                    const settings = data.settings;
                    if (settings.use_simulator !== undefined) {
                        document.getElementById('use_simulator').checked = settings.use_simulator;
                    }
                    // The unit_system from settings.json is no longer used to drive display conversions here.
                    // User profile's unit_preference is the master for display.
                }
            })
            .catch(error => console.error('Error loading app settings:', error));
    }
    
    // Save user profile
    userProfileForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(userProfileForm);
        const profile = {};
        
        for (const [key, value] of formData.entries()) {
            const trimmedValue = typeof value === 'string' ? value.trim() : value;
            if (trimmedValue !== '' && trimmedValue !== null) {
                if (['age', 'max_heart_rate', 'resting_heart_rate', 'ftp'].includes(key)) {
                    profile[key] = parseInt(trimmedValue);
                } else if (key === 'weight') {
                    let weightValue = parseFloat(trimmedValue);
                    if (!isNaN(weightValue)) {
                         if (currentUnitSystem === 'imperial') {
                            weightValue = unitConversions.lbsToKg(weightValue);
                        }
                        profile[key] = parseFloat(weightValue.toFixed(1));
                    }
                } else if (key === 'height') {
                    let heightValue = parseInt(trimmedValue);
                     if (!isNaN(heightValue)) {
                        if (currentUnitSystem === 'imperial') {
                            heightValue = unitConversions.inchesToCm(heightValue);
                        }
                        profile[key] = Math.round(heightValue);
                    }
                } else {
                    profile[key] = trimmedValue;
                }
            }
        }
        
        profile.unit_preference = currentUnitSystem; // Save the currently selected unit system preference
        
        fetch('/api/user_profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(profile)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User profile saved successfully');
                loadUserProfile(); // Reload to confirm and store original values again
            } else {
                alert(`Error saving user profile: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error saving user profile: ${error.message}`);
            console.error('Error saving user profile:', error);
        });
    });
    
    // Save Garmin settings
    garminSettingsForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(garminSettingsForm);
        const garminSettings = {};
        // Only include fields if they have a value
        if (formData.get('garmin_username').trim()) {
            garminSettings.garmin_username = formData.get('garmin_username').trim();
        }
        if (formData.get('garmin_password')) { // Password can be saved even if it appears empty to clear it
            garminSettings.garmin_password = formData.get('garmin_password');
        }

        // Garmin settings are typically saved as part of the user profile or a separate garmin_settings.json
        // Assuming they are part of user_profile.json for this example, based on loadUserProfile logic
        fetch('/api/user_profile') // Fetch current profile to merge
            .then(response => response.json())
            .then(profileData => {
                let profileToSave = (profileData && profileData.success && profileData.profile) ? profileData.profile : {};
                Object.assign(profileToSave, garminSettings); // Merge Garmin settings

                fetch('/api/user_profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileToSave)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Garmin settings saved successfully');
                    } else {
                        alert(`Error saving Garmin settings: ${data.error || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    alert(`Error saving Garmin settings: ${error.message}`);
                    console.error('Error saving Garmin settings:', error);
                });
            });
    });
    
    // Save app settings
    appSettingsForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(appSettingsForm);
        const settingsToSave = {};
        settingsToSave.use_simulator = formData.has('use_simulator');
        // The unit_system_preference radio buttons are for user profile, not app settings file.
        // So, we don't save unit_system to settings.json from here anymore to avoid confusion.
        // If it was intended to be an app-level default, that logic would be different.

        fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settingsToSave)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Application settings saved successfully');
            } else {
                alert(`Error saving application settings: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            alert(`Error saving application settings: ${error.message}`);
            console.error('Error saving application settings:', error);
        });
    });
    
    // Initial load
    loadUserProfile(); 
    loadAppSettings(); 

</script>
{% endblock %}

