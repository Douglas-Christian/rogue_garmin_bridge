{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Workout Tracking</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Workout Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="workout-status-card">
                            <p>Status: <span id="status-text" class="badge bg-secondary">Disconnected</span></p>
                            <p>Device: <span id="device-name">None</span></p>
                            <p>Workout: <span id="workout-status" class="badge bg-secondary">Inactive</span></p>
                            <p>Duration: <span id="workout-duration">00:00:00</span></p> 
                        </div>
                        <div class="mt-3">
                            <button id="start-workout-btn" class="btn btn-success" disabled>Start Workout</button>
                            <button id="end-workout-btn" class="btn btn-danger" disabled>End Workout</button>
                            <a href="/devices" class="btn btn-primary">Manage Devices</a>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Current Metrics</h5>
                    </div>
                    <div class="card-body">
                        <div id="current-metrics">
                            <div class="row">
                                <div class="col-6">
                                    <div class="metric-card">
                                        <h6>Power</h6>
                                        <p id="power-value" class="metric-value">0</p>
                                        <p class="metric-unit">watts</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card">
                                        <h6>Heart Rate</h6>
                                        <p id="heart-rate-value" class="metric-value">0</p>
                                        <p class="metric-unit">bpm</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <div class="metric-card">
                                        <h6 id="cadence-label">Cadence</h6>
                                        <p id="cadence-value" class="metric-value">0</p>
                                        <p id="cadence-unit" class="metric-unit">rpm</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card">
                                        <h6>Speed</h6>
                                        <p id="speed-value" class="metric-value">0</p>
                                        <p class="metric-unit">km/h</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <div class="metric-card">
                                        <h6>Distance</h6>
                                        <p id="distance-value" class="metric-value">0</p>
                                        <p class="metric-unit">m</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card">
                                        <h6>Calories</h6>
                                        <p id="calories-value" class="metric-value">0</p>
                                        <p class="metric-unit">kcal</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Workout Charts</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="power-tab" data-bs-toggle="tab" data-bs-target="#power-chart-tab" type="button" role="tab" aria-controls="power-chart-tab" aria-selected="true">Power</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="heart-rate-tab" data-bs-toggle="tab" data-bs-target="#heart-rate-chart-tab" type="button" role="tab" aria-controls="heart-rate-chart-tab" aria-selected="false">Heart Rate</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="cadence-tab" data-bs-toggle="tab" data-bs-target="#cadence-chart-tab" type="button" role="tab" aria-controls="cadence-chart-tab" aria-selected="false">Cadence</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="chartTabsContent">
                            <div class="tab-pane fade show active" id="power-chart-tab" role="tabpanel" aria-labelledby="power-tab">
                                <div class="chart-container" style="position: relative; height:300px;">
                                    <canvas id="power-chart"></canvas>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="heart-rate-chart-tab" role="tabpanel" aria-labelledby="heart-rate-tab">
                                <div class="chart-container" style="position: relative; height:300px;">
                                    <canvas id="heart-rate-chart"></canvas>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="cadence-chart-tab" role="tabpanel" aria-labelledby="cadence-tab">
                                <div class="chart-container" style="position: relative; height:300px;">
                                    <canvas id="cadence-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Workout Summary</h5>
                    </div>
                    <div class="card-body">
                        <div id="workout-summary">
                            <p>Start a workout to see summary metrics.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM elements
    const statusText = document.getElementById('status-text');
    const deviceName = document.getElementById('device-name');
    const workoutStatus = document.getElementById('workout-status');
    const workoutDuration = document.getElementById('workout-duration');
    const startWorkoutBtn = document.getElementById('start-workout-btn');
    const endWorkoutBtn = document.getElementById('end-workout-btn');
    
    // Metric elements
    const powerValue = document.getElementById('power-value');
    const heartRateValue = document.getElementById('heart-rate-value');
    const cadenceLabel = document.getElementById('cadence-label');
    const cadenceValue = document.getElementById('cadence-value');
    const cadenceUnit = document.getElementById('cadence-unit');
    const speedValue = document.getElementById('speed-value');
    const distanceValue = document.getElementById('distance-value');
    const caloriesValue = document.getElementById('calories-value');
    
    // Charts
    let powerChart, heartRateChart, cadenceChart;
    const maxDataPoints = 60; // 1 minute of data at 1 second intervals
    
    // Chart data
    const powerData = {
        labels: Array(maxDataPoints).fill(''),
        datasets: [{
            label: 'Power (watts)',
            data: Array(maxDataPoints).fill(null),
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            fill: true,
            tension: 0.4
        }]
    };
    
    const heartRateData = {
        labels: Array(maxDataPoints).fill(''),
        datasets: [{
            label: 'Heart Rate (bpm)',
            data: Array(maxDataPoints).fill(null),
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            fill: true,
            tension: 0.4
        }]
    };
    
    const cadenceData = {
        labels: Array(maxDataPoints).fill(''),
        datasets: [{
            label: 'Cadence (rpm)',
            data: Array(maxDataPoints).fill(null),
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true,
            tension: 0.4
        }]
    };
    
    // Chart options
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                display: false
            },
            y: {
                beginAtZero: true
            }
        },
        animation: {
            duration: 0
        }
    };
    
    // Initialize charts
    function initCharts() {
        const powerCtx = document.getElementById('power-chart').getContext('2d');
        powerChart = new Chart(powerCtx, {
            type: 'line',
            data: powerData,
            options: chartOptions
        });
        
        const heartRateCtx = document.getElementById('heart-rate-chart').getContext('2d');
        heartRateChart = new Chart(heartRateCtx, {
            type: 'line',
            data: heartRateData,
            options: chartOptions
        });
        
        const cadenceCtx = document.getElementById('cadence-chart').getContext('2d');
        cadenceChart = new Chart(cadenceCtx, {
            type: 'line',
            data: cadenceData,
            options: chartOptions
        });
    }
    
    // Update charts with new data
    function updateCharts(data) {
        // Update power chart
        if (data.instant_power !== undefined || data.power !== undefined) { // Corrected key: instant_power
            const power = data.instant_power || data.power || 0;
            powerData.datasets[0].data.push(power);
            powerData.datasets[0].data.shift();
            powerChart.update();
        }
        
        // Update heart rate chart
        if (data.heart_rate !== undefined) {
            heartRateData.datasets[0].data.push(data.heart_rate);
            heartRateData.datasets[0].data.shift();
            heartRateChart.update();
        }
        
        // Update cadence chart
        if (data.instant_cadence !== undefined || data.cadence !== undefined || data.stroke_rate !== undefined) { // Corrected key: instant_cadence
            const cadence = data.instant_cadence || data.cadence || data.stroke_rate || 0;
            cadenceData.datasets[0].data.push(cadence);
            cadenceData.datasets[0].data.shift();
            cadenceChart.update();
        }
    }
    
    // Update metrics with new data
    function updateMetrics(data) {
        if (!data) return;
        
        console.log("Updating metrics with data:", data);
        
        // Update workout type specific metrics
        const workoutType = data.type || 'unknown';
        
        // Update power
        if (data.instant_power !== undefined || data.power !== undefined) { // Corrected key: instant_power
            const power = data.instant_power || data.power || 0;
            powerValue.textContent = Math.round(power);
        }
        
        // Update heart rate
        if (data.heart_rate !== undefined) {
            heartRateValue.textContent = Math.round(data.heart_rate);
        }
        
        // Update cadence or stroke rate based on workout type
        if (workoutType === 'bike') {
            cadenceLabel.textContent = 'Cadence';
            cadenceUnit.textContent = 'rpm';
            
            if (data.instant_cadence !== undefined || data.cadence !== undefined) { // Corrected key: instant_cadence
                const cadence = data.instant_cadence || data.cadence || 0;
                cadenceValue.textContent = Math.round(cadence);
            }
        } else if (workoutType === 'rower') {
            cadenceLabel.textContent = 'Stroke Rate';
            cadenceUnit.textContent = 'spm';
            
            if (data.stroke_rate !== undefined) {
                cadenceValue.textContent = Math.round(data.stroke_rate);
            }
        }
        
        // Update speed
        if (data.instant_speed !== undefined || data.speed !== undefined) { // Corrected key: instant_speed
            const speed = data.instant_speed || data.speed || 0;
            // Convert m/s to km/h
            const speedKmh = speed * 3.6;
            speedValue.textContent = speedKmh.toFixed(1);
        }
        
        // Update distance
        if (data.total_distance !== undefined || data.distance !== undefined) {
            const distance = data.total_distance || data.distance || 0;
            distanceValue.textContent = Math.round(distance);
        }
        
        // Update calories
        if (data.total_energy !== undefined || data.calories !== undefined) {
            const calories = data.total_energy || data.calories || 0;
            caloriesValue.textContent = Math.round(calories);
        }
        
        // Update workout duration if available
        if (data.elapsed_time !== undefined) {
            workoutDuration.textContent = formatDuration(data.elapsed_time);
        }
    }
    
    // Format duration
    function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        return [
            hours.toString().padStart(2, '0'),
            minutes.toString().padStart(2, '0'),
            secs.toString().padStart(2, '0')
        ].join(':');
    }
    
    // Update workout summary
    function updateWorkoutSummary(data) {
        const summaryElement = document.getElementById('workout-summary');
        
        if (!data || Object.keys(data).length === 0) {
            summaryElement.innerHTML = '<p>Start a workout to see summary metrics.</p>';
            return;
        }
        
        // Get workout type
        const workoutType = data.type || 'unknown';
        
        // Create summary HTML
        let html = '<div class="row">';
        
        // Average power
        if (data.instant_power || data.power) {
            const power = data.instant_power || data.power || 0;
            html += `
                <div class="col-6">
                    <p><strong>Avg Power:</strong> <span id="avg-power">-</span> W</p>
                </div>
            `;
        }
        
        // Average heart rate
        if (data.heart_rate) {
            html += `
                <div class="col-6">
                    <p><strong>Avg Heart Rate:</strong> <span id="avg-heart-rate">-</span> bpm</p>
                </div>
            `;
        }
        
        // Average cadence or stroke rate
        if (workoutType === 'bike') {
            html += `
                <div class="col-6">
                    <p><strong>Avg Cadence:</strong> <span id="avg-cadence">-</span> rpm</p>
                </div>
            `;
        } else if (workoutType === 'rower') {
            html += `
                <div class="col-6">
                    <p><strong>Avg Stroke Rate:</strong> <span id="avg-stroke-rate">-</span> spm</p>
                </div>
            `;
        }
        
        // Total distance
        html += `
            <div class="col-6">
                <p><strong>Total Distance:</strong> <span id="total-distance">-</span> m</p>
            </div>
        `;
        
        // Total calories
        html += `
            <div class="col-6">
                <p><strong>Total Calories:</strong> <span id="total-calories">-</span> kcal</p>
            </div>
        `;
        
        // Estimated VO2 Max
        html += `
            <div class="col-6">
                <p><strong>Est. VO2 Max:</strong> <span id="est-vo2max">-</span></p>
            </div>
        `;
        
        html += '</div>';
        
        summaryElement.innerHTML = html;
    }
    
    // Start workout button listener
    startWorkoutBtn.addEventListener('click', function() {
        // First fetch the current status to get the connected device address
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                if (data.device_status === 'connected') {
                    const deviceAddress = data.connected_device_address;
                    
                    if (!deviceAddress) {
                        console.error('Cannot start workout: Connected device address not found in status response.');
                        alert('Error: Could not determine the connected device address.');
                        return;
                    }
                    
                    console.log('Starting workout with device ID:', deviceAddress);
                    
                    // Now call the start_workout endpoint with the device ID
                    fetch('/api/start_workout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            device_id: deviceAddress
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Workout logging started:', data);
                            updateStatus(); // Update UI to reflect active workout
                        } else {
                            console.error('Error starting workout logging:', data.error);
                            alert('Error starting workout logging: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error starting workout logging:', error);
                        alert('Error starting workout logging: ' + error.message);
                    });
                } else {
                    alert('Cannot start workout: No device connected.');
                }
            })
            .catch(error => {
                console.error('Error fetching device status:', error);
                alert('Error: Could not fetch device status. ' + error.message);
            });
    });

    // Re-add End workout button listener
    endWorkoutBtn.addEventListener('click', function() {
        fetch('/api/end_workout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({}) // No body needed for end
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Workout logging ended successfully');
                alert('Workout logging ended successfully');
                
                // Update UI immediately
                workoutStatus.textContent = 'Inactive';
                workoutStatus.className = 'badge bg-secondary';
                startWorkoutBtn.disabled = (statusText.textContent !== 'Connected'); // Re-enable start if connected
                endWorkoutBtn.disabled = true;
                
                // Optionally redirect to history page
                // if (data.workout_id) {
                //     window.location.href = `/history?workout_id=${data.workout_id}`;
                // }
                updateStatus(); // Refresh full status
            } else {
                console.error('Error ending workout logging:', data.error);
                alert('Error ending workout logging: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error ending workout logging:', error);
            alert('Error ending workout logging: ' + error.message);
        });
    });
    
    // Update status
    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                console.log("Workout status data:", data); // Debug output
                
                // Connection status
                if (data.device_status === 'connected') {
                    statusText.textContent = 'Connected';
                    statusText.className = 'badge bg-success';
                    // Use the nested connected_device object for name
                    if (data.connected_device && data.connected_device.name) {
                        deviceName.textContent = data.connected_device.name;
                    } else {
                        deviceName.textContent = data.connected_device_address || 'Unknown'; // Fallback
                    }
                } else {
                    statusText.textContent = 'Disconnected';
                    statusText.className = 'badge bg-secondary';
                    deviceName.textContent = 'None';
                }
                
                // Update workout status and button states
                if (data.workout_active) {
                    workoutStatus.textContent = 'Active';
                    workoutStatus.className = 'badge bg-success';
                    startWorkoutBtn.disabled = true; // Disable start if active
                    endWorkoutBtn.disabled = false; // Enable end if active
                } else {
                    workoutStatus.textContent = 'Inactive';
                    workoutStatus.className = 'badge bg-secondary';
                    // Enable start only if connected and workout inactive
                    startWorkoutBtn.disabled = (data.device_status !== 'connected'); 
                    endWorkoutBtn.disabled = true; // Disable end if inactive
                }
                
                // Update metrics
                if (data.latest_data) {
                    updateMetrics(data.latest_data);
                    updateCharts(data.latest_data);
                    // updateWorkoutSummary(data.latest_data); // Keep summary commented for now
                } else {
                    updateMetrics({}); 
                }
            })
            .catch(error => {
                console.error('Error fetching status:', error);
                statusText.textContent = 'Error';
                statusText.className = 'badge bg-danger';
                // Disable buttons on error
                startWorkoutBtn.disabled = true;
                endWorkoutBtn.disabled = true;
            });
    }
    
    // Function to reconnect to a device without user interaction
    function reconnectToDevice(address) {
        if (!address) return;
        
        fetch('/api/connect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                address: address
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Reconnected to device:', address);
                
                // Force an immediate status update
                updateStatus();
            } else {
                console.error('Error reconnecting to device:', data.error);
            }
        })
        .catch(error => {
            console.error('Error reconnecting to device:', error);
        });
    }
    
    // Initialize charts on page load
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        
        // Initial status check
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                console.log("Initial status check on workout page:", data);
                
                if (data.device_status === 'connected') {
                    console.log("Device is connected - immediately updating UI");
                    statusText.textContent = 'Connected';
                    statusText.className = 'badge bg-success';
                    // Use the nested connected_device object for name
                    if (data.connected_device && data.connected_device.name) {
                        deviceName.textContent = data.connected_device.name;
                    } else {
                        deviceName.textContent = data.connected_device_address || 'Unknown'; // Fallback
                    }

                    // Set initial button states based on workout status
                    if (!data.workout_active) {
                        console.log("No active workout - enabling Start Workout button");
                        startWorkoutBtn.disabled = false;
                        endWorkoutBtn.disabled = true;
                        workoutStatus.textContent = 'Inactive';
                        workoutStatus.className = 'badge bg-secondary';
                    } else {
                        startWorkoutBtn.disabled = true;
                        endWorkoutBtn.disabled = false;
                        workoutStatus.textContent = 'Active';
                        workoutStatus.className = 'badge bg-success';
                    }
                    
                    if (data.latest_data) {
                        updateMetrics(data.latest_data);
                        updateCharts(data.latest_data);
                        // updateWorkoutSummary(data.latest_data);
                    }
                } else {
                     // Ensure buttons are disabled if not connected initially
                     startWorkoutBtn.disabled = true;
                     endWorkoutBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error("Error in initial status check:", error);
                 startWorkoutBtn.disabled = true; // Disable buttons on error
                 endWorkoutBtn.disabled = true;
            });
        
        // Start regular status updates
        updateStatus();
        setInterval(updateStatus, 1000); 
    });
</script>
{% endblock %}